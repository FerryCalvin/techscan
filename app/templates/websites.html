{% extends 'base.html' %}
{% block content %}
<h2>Website List</h2>
<div class="grid cols-2">
  <article>
    <input id="filter" placeholder="Cari domain..." />
    <small id="summary" class="mono"></small>
  </article>
  <article style="text-align:right">
    <button id="reload-groups" class="secondary">Reload Groups</button>
  </article>
</div>
<div class="group-grid" id="group-sections">
  <!-- Sections injected here -->
</div>
<dialog id="detail-dialog">
  <article style="max-width:880px; position:relative;">
    <header style="display:flex; align-items:center; gap:.75rem;">
      <h5 id="detail-title" style="flex:1 1 auto;">Domain Detail</h5>
      <button id="rescan-btn" class="secondary outline" style="font-size:.65rem;">Re-Scan</button>
      <button id="detail-close" rel="prev" class="close" aria-label="Close"></button>
    </header>
    <div id="detail-loader" class="loading-overlay" style="display:none"><div class="spinner"></div></div>
    <section id="detail-meta" class="small"></section>
    <section>
      <h6 style="margin-bottom:0.3rem">Technologies</h6>
      <table id="detail-tech-table">
        <thead><tr><th>Name</th><th>Version</th><th>Categories</th><th>Confidence</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
    <section class="grid cols-2">
      <article>
        <h6>Diff Added</h6>
        <ul id="diff-added" class="small"></ul>
      </article>
      <article>
        <h6>Diff Removed</h6>
        <ul id="diff-removed" class="small"></ul>
      </article>
    </section>
    <section>
      <h6>Diff Changed</h6>
      <ul id="diff-changed" class="small"></ul>
    </section>
  </article>
</dialog>
{% endblock %}
{% block scripts %}
<script>
const sectionsDiv = document.getElementById('group-sections');
const filterInput = document.getElementById('filter');
const summaryEl = document.getElementById('summary');
const dlg = document.getElementById('detail-dialog');
const detailTitle = document.getElementById('detail-title');
const detailMeta = document.getElementById('detail-meta');
const techTbody = document.querySelector('#detail-tech-table tbody');
const diffAdded = document.getElementById('diff-added');
const diffRemoved = document.getElementById('diff-removed');
const diffChanged = document.getElementById('diff-changed');

function sectionSkeleton(title, key){
  return `<section data-group="${key}">
    <h4>${title}</h4>
    <div class="card-grid" id="cards-${key}"></div>
    <div class="small" id="more-wrapper-${key}" style="margin-top:.5rem"></div>
  </section>`;
}

// state for pagination
const groupState = {}; // key -> {all:[], shown:0}
const PAGE_SIZE = 60;

async function load(){
  sectionsDiv.innerHTML = '<p>Loading...</p>';
  try {
    const data = await apiFetch('/api/domains');
    render(data);
  } catch(e){ sectionsDiv.innerHTML = '<p class="small">Error '+e.message+'</p>'; }
}

function render(data){
  summaryEl.textContent = `Total ${data.summary.total_domains} | Scanned ${data.summary.scanned} | Unscanned ${data.summary.unscanned}`;
  const f = (filterInput.value||'').toLowerCase();
  const orderKeys = ['faculty','directorate','work_unit','bem_ukm'];
  sectionsDiv.innerHTML = orderKeys.map(k=>{
    const g = data.groups.find(x=> x.key===k) || {key:k,label:k.replace('_',' ').toUpperCase(),domains:[],count:0};
    return sectionSkeleton(g.label + ` (${g.count})`, k);
  }).join('');
  // cards
  orderKeys.forEach(k=>{
    const g = data.groups.find(x=> x.key===k) || {domains:[]};
    const filtered = (g.domains||[]).filter(d=> !f || d.domain.includes(f));
    groupState[k] = { all: filtered, shown: 0 };
    const container = document.getElementById('cards-'+k);
    if(!filtered.length){ container.innerHTML = '<p class="small">(empty)</p>'; return; }
    container.innerHTML = '';
    renderMore(k);
  });
  // append ungrouped at bottom if any
  if(data.ungrouped && data.ungrouped.length){
    const extra = document.createElement('section');
    extra.innerHTML = `<h4>Ungrouped (${data.ungrouped.length})</h4><div class='card-grid' id='cards-ungrouped'></div>`;
    sectionsDiv.appendChild(extra);
    const container = document.getElementById('cards-ungrouped');
    const filteredUG = data.ungrouped.filter(d=> !f || d.domain.includes(f));
    groupState['ungrouped'] = { all: filteredUG, shown:0 };
    container.innerHTML='';
    // add load more wrapper
    const wrap = document.createElement('div');
    wrap.id = 'more-wrapper-ungrouped';
    wrap.className='small';
    wrap.style.marginTop='.5rem';
    container.parentElement.appendChild(wrap);
    renderMore('ungrouped');
  }
  sectionsDiv.querySelectorAll('.domain-card').forEach(el=> el.addEventListener('click', ()=> showDetail(el.dataset.domain)));
}

function renderMore(key){
  const st = groupState[key];
  if(!st) return;
  const container = document.getElementById('cards-'+key);
  const slice = st.all.slice(st.shown, st.shown + PAGE_SIZE);
  slice.forEach(d=> container.insertAdjacentHTML('beforeend', cardHTML(d)));
  st.shown += slice.length;
  const wrap = document.getElementById('more-wrapper-'+key);
  if(wrap){
    if(st.shown < st.all.length){
      wrap.innerHTML = `<button class='secondary outline small' data-more='${key}'>Load More (${st.shown}/${st.all.length})</button>`;
      wrap.querySelector('button').addEventListener('click', ()=>{ renderMore(key); attachCardHandlers(); });
    } else if(st.all.length > PAGE_SIZE) {
      wrap.innerHTML = `<span>All loaded (${st.all.length})</span>`;
    } else {
      wrap.innerHTML='';
    }
  }
  attachCardHandlers();
}

function attachCardHandlers(){
  sectionsDiv.querySelectorAll('.domain-card').forEach(el=>{
    if(!el.dataset.bound){
      el.dataset.bound='1';
      el.addEventListener('click', ()=> showDetail(el.dataset.domain));
    }
  });
}

function cardHTML(d){
  const last = d.last_scan_ts ? new Date(d.last_scan_ts*1000).toLocaleString() : 'never';
  const badges = [];
  if(d.diff_added) badges.push(`<span class='badge diff-added' title='Added technologies'>+${d.diff_added}</span>`);
  if(d.diff_removed) badges.push(`<span class='badge diff-removed' title='Removed technologies'>-${d.diff_removed}</span>`);
  if(d.diff_changed) badges.push(`<span class='badge diff-changed' title='Changed versions'>Â±${d.diff_changed}</span>`);
  const badgeHtml = badges.length? `<div class='dc-badges'>${badges.join(' ')}</div>`:'';
  return `<div class='domain-card' data-domain='${d.domain}'>
    <div class='dc-title'>${d.domain}</div>
    <div class='dc-meta small mono'>tech:${d.tech_count} | last:${last}${d.last_mode? ' | '+d.last_mode:''}</div>
    ${badgeHtml}
  </div>`;
}

async function showDetail(domain){
  detailTitle.textContent = domain;
  techTbody.innerHTML = '<tr><td colspan="4" class="small">Loading...</td></tr>';
  diffAdded.innerHTML = diffRemoved.innerHTML = diffChanged.innerHTML = '';
  detailMeta.textContent='';
  dlg.showModal();
  const loader = document.getElementById('detail-loader');
  loader.style.display='flex';
  try {
    const data = await apiFetch(`/api/domain/${domain}/detail`);
    // Meta
    const latest = data.latest; const prev = data.previous;
    detailMeta.innerHTML = `<strong>Latest Mode:</strong> ${latest.mode} | <strong>Finished:</strong> ${new Date(latest.finished_at*1000).toLocaleString()}${prev? ' | Prev: '+new Date(prev.finished_at*1000).toLocaleString():''}`;
    if(data.status === 'in-progress'){
      detailMeta.innerHTML += ` <span class='badge' style='background:#1e3a8a;margin-left:.5rem'>In Progress${data.eta_seconds? ' ~'+data.eta_seconds+'s':''}</span>`;
    }
    // Tech table
    techTbody.innerHTML = '';
    const addedNames = new Set((data.diff.added||[]).map(x=> x.name));
    const changedNames = new Set((data.diff.changed||[]).map(x=> x.name));
    (data.technologies||[]).forEach(t=>{
      const tr = document.createElement('tr');
      if(addedNames.has(t.name)) tr.classList.add('diff-added');
      else if(changedNames.has(t.name)) tr.classList.add('diff-changed');
      tr.innerHTML = `<td>${t.name}</td><td>${t.version||''}</td><td>${(t.categories||[]).join(', ')}</td><td>${t.confidence||''}</td>`;
      techTbody.appendChild(tr);
    });
    if(!techTbody.children.length){ techTbody.innerHTML = '<tr><td colspan="4" class="small">(no technologies)</td></tr>'; }
    // Diff
  (data.diff.added||[]).forEach(a=>{ const li=document.createElement('li'); li.className='diff-added'; li.textContent = a.name + (a.version? ' '+a.version:''); diffAdded.appendChild(li); });
  (data.diff.removed||[]).forEach(r=>{ const li=document.createElement('li'); li.className='diff-removed'; li.textContent = r.name + (r.version? ' '+r.version:''); diffRemoved.appendChild(li); });
  (data.diff.changed||[]).forEach(c=>{ const li=document.createElement('li'); li.className='diff-changed'; li.textContent = `${c.name}: ${c.from||'(none)'} -> ${c.to||'(none)'}`; diffChanged.appendChild(li); });
    if(!diffAdded.children.length) diffAdded.innerHTML = '<li class="small">(none)</li>';
    if(!diffRemoved.children.length) diffRemoved.innerHTML = '<li class="small">(none)</li>';
    if(!diffChanged.children.length) diffChanged.innerHTML = '<li class="small">(none)</li>';
  } catch(e){
    techTbody.innerHTML = `<tr><td colspan='4' class='small'>Error ${e.message}</td></tr>`;
  } finally {
    loader.style.display='none';
  }
}

// quick re-scan with polling
let polling = null;
async function triggerRescan(){
  const domain = detailTitle.textContent;
  const btn = document.getElementById('rescan-btn');
  if(!domain) return;
  if(polling){ return; }
  btn.disabled = true; btn.textContent='Scanning...';
  try {
    await fetch('/scan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domain, fast_full:1}) });
  } catch(e){
    btn.disabled=false; btn.textContent='Re-Scan'; alert('Scan start failed: '+e.message); return;
  }
  // poll detail every 2s up to 60s
  const start = Date.now();
  const poll = async ()=>{
    try {
      const data = await apiFetch(`/api/domain/${domain}/detail`);
      if(data.latest && (Date.now()/1000 - data.latest.finished_at) < 120){
        // assume new scan finished (recent finished_at)
        btn.disabled=false; btn.textContent='Re-Scan'; polling=null; showDetail(domain); return;
      }
    } catch(e){}
    if(Date.now() - start < 60000){ polling = setTimeout(poll, 2000); } else { btn.disabled=false; btn.textContent='Re-Scan'; polling=null; }
  };
  poll();
}

document.getElementById('rescan-btn').addEventListener('click', triggerRescan);

filterInput.addEventListener('input', load);
document.getElementById('detail-close').addEventListener('click', ()=> dlg.close());
document.getElementById('reload-groups').addEventListener('click', async ()=>{ try { await fetch('/admin/domain_groups/reload',{method:'POST'}); load(); } catch(e){ alert('Reload failed '+e.message);} });
load();
</script>
{% endblock %}
