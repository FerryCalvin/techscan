{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stats.css') }}">
{% endblock %}

{% block content %}
<div class="page-wrapper">

  <section class="hero-intro" style="padding:1.5rem 0 1rem; text-align:center;">
    <h1 class="hero-title"
      style="font-size:clamp(2rem,5vw,3rem); font-weight:700; background:linear-gradient(92deg,#34d399,#22d3ee 55%,#60a5fa); -webkit-background-clip:text; background-clip:text; color:transparent;">
      System Dashboard
    </h1>
    <p class="hero-lead" style="max-width:800px;margin:0 auto;">
      Monitor system performance, scan statistics, and technology trends.{% if config.get('STATS_AUTO_REFRESH') %}
      Auto-refresh: {{ (config.get('STATS_AUTO_REFRESH_INTERVAL_MS', 300000)|int / 60000)|round|int }} min{% else %}
      Press Ctrl+F5 to refresh.{% endif %}
    </p>
  </section>

  <div class="dashboard-wrapper"
    style="display:flex;flex-direction:column;align-items:center;gap:1rem;margin-top:1rem;">

    <!-- ðŸŸ¢ Header Summary -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;">
        <div class="mini-card">
          <div class="mini-label">Total Scans</div>
          <div class="mini-value" id="total-scans">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Total Domains</div>
          <div class="mini-value" id="total-domains">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Total Payload (All Time)</div>
          <div class="mini-value mini-value-small" id="total-payload">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Avg Duration (s)</div>
          <div class="mini-value" id="avg-duration">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Uptime</div>
          <div class="mini-value" id="uptime">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Last Scan</div>
          <div class="mini-value mini-value-small" id="last-scan">-</div>
        </div>
      </div>
      <div id="system-health" style="display:flex;gap:1rem;margin-top:.8rem;justify-content:center;">
        <span class="health-tag" id="redis-status">Redis: -</span>
        <span class="health-tag" id="db-status">DB: -</span>
        <span class="health-tag" id="queue-status">Queue: -</span>
      </div>
    </div>

    <!--  Payload Footprint -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <div
        style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.8rem;">
        <h3 style="margin:0;font-size:1rem;">Payload Footprint</h3>
        <span class="small-note" style="font-size:0.6rem;opacity:0.7;">Averages computed from completed scans</span>
      </div>
      <div class="payload-grid">
        <div class="payload-card">
          <div class="payload-label">Avg 24h</div>
          <div class="payload-value" id="payload-daily">-</div>
        </div>
        <div class="payload-card">
          <div class="payload-label">Avg 7d</div>
          <div class="payload-value" id="payload-weekly">-</div>
        </div>
        <div class="payload-card">
          <div class="payload-label">Avg 30d</div>
          <div class="payload-value" id="payload-monthly">-</div>
        </div>
      </div>
    </div>

    <!-- ðŸ“Š Performance -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <h3 style="margin-bottom:1rem;">Scan Performance</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;align-items:start;">
        {% with title='Throughput (scan/hour)', canvas_id='throughputChart' %}
        {% include 'partials/stats/_chart_card.html' %}
        {% endwith %}

        <div class="chart-container">
          <h4 class="chart-title">Average Confidence Score</h4>
          <div
            style="position:relative;height:200px;width:100%;display:flex;align-items:center;justify-content:center;">
            <div id="confidence-display" style="text-align:center;">
              <div style="font-size:3rem;font-weight:700;color:#60a5fa;" id="confidence-value">-</div>
              <div class="confidence-label">Overall Confidence</div>
            </div>
          </div>
        </div>

        {% with title='Result Breakdown', canvas_id='resultPie' %}
        {% include 'partials/stats/_chart_card.html' %}
        {% endwith %}
      </div>
    </div>

    <!-- ðŸ§  Top Technologies -->
    {% with title='Top 10 Technologies', col2_header='Technology', col2_width='50%', col3_header='Category',
    col3_width='25%', tbody_id='top-tech-body' %}
    {% include 'partials/stats/_tech_list.html' %}
    {% endwith %}

    <!-- ðŸ§© Categories -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <h3>Top 10 Categories</h3>
      <table class="tech-table table-glass table-glass--compact" style="width:100%;margin-top:.5rem;font-size:0.7rem;">
        <thead>
          <tr style="text-align:left;">
            <th style="width:10%;">#</th>
            <th style="width:70%;">Category</th>
            <th style="width:20%;text-align:right;">Count</th>
          </tr>
        </thead>
        <tbody id="top-cat-body"></tbody>
      </table>
    </div>

    <!-- ðŸ“Š Category Classification -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <h3 style="margin-bottom:1rem;">Category Classification</h3>
      <div class="carousel-container" id="carousel-container"
        style="overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;">
        <div class="carousel-track" id="category-charts-container" style="display:flex;gap:1.5rem;padding:0.5rem 0;">
          <!-- Pie charts will be dynamically inserted here -->
        </div>
      </div>
    </div>

  </div>

  <!-- ðŸªŸ Modal for Technology Domains -->
  <div id="techModal" class="modal hidden">
    <div class="tech-modal-panel">
      <div class="tech-modal-header">
        <div class="tech-header-left">
          <img id="modal-tech-icon" class="tech-icon-large" src="" alt="" style="display: none;">
          <div>
            <p class="tech-modal-label">Technology</p>
            <h3 id="modal-tech-name">Technology</h3>
            <p id="modal-category" class="modal-subtitle"></p>
          </div>
        </div>
        <div class="tech-modal-actions">
          <a id="tech-drill-link" class="secondary outline" target="_blank" rel="noopener">Open Explorer</a>
          <button id="copy-tech-btn" class="secondary outline" type="button">Copy Name</button>
          <button onclick="closeTechModal()" class="ghost icon" aria-label="Close">&times;</button>
        </div>
      </div>
      <div class="tech-modal-metrics">
        <div class="metric-card">
          <span class="metric-label">Usage Count</span>
          <span class="metric-value" id="modal-tech-usage">-</span>
        </div>

        <div class="metric-card">
          <span class="metric-label">Share of Top Stack</span>
          <span class="metric-value" id="modal-tech-share">-</span>
        </div>
      </div>
      <section class="tech-modal-body">
        <header class="tech-modal-body-header">
          <h4>Websites using this technology</h4>
          <div class="tech-modal-filter">
            <input id="modal-domain-search" type="search" placeholder="Filter domains..." />
            <span id="modal-domain-count" class="small">0 domains</span>
          </div>
        </header>
        <ul id="modal-domains-list" class="domain-chip-list"></ul>
      </section>
    </div>
  </div>

  <!-- ðŸªŸ Modal for Category Chart with side-by-side layout -->
  <div id="categoryModal" class="modal hidden">
    <div style="display:flex;gap:1rem;margin:5rem auto 2rem;max-width:95%;max-height:70vh;">
      <!-- Left: Category Technologies -->
      <div class="modal-content glass-card" style="flex:1;max-width:700px;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h3 id="modal-cat-name" style="margin:0;">Category</h3>
          <button onclick="closeCategoryModal()" class="modal-close-btn">Close</button>
        </div>
        <div style="position:relative;height:250px;margin-bottom:1rem;">
          <canvas id="categoryTechChart"></canvas>
        </div>
        <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">Technologies in this category:</h4>
        <table class="tech-table" style="width:100%;">
          <thead>
            <tr style="text-align:left;">
              <th>Technology</th>
              <th style="text-align:right;">Usage Count</th>
            </tr>
          </thead>
          <tbody id="modal-cat-tech-body"></tbody>
        </table>
      </div>

      <!-- Right: Tech Domains (hidden initially) -->
      <div id="sideTechModal" class="modal-content glass-card"
        style="flex:1;max-width:500px;overflow-y:auto;display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <div>
            <h3 id="side-modal-tech-name" style="margin:0;font-size:1.1rem;">Technology</h3>
            <p id="side-modal-category" class="modal-subtitle-small"></p>
          </div>
          <button onclick="closeSideTechModal()" class="modal-close-btn-small">âœ•</button>
        </div>
        <h4 style="margin-bottom:0.5rem;font-size:0.9rem;">Websites using this technology:</h4>
        <ul id="side-modal-domains-list" style="list-style:none;padding:0;max-height:500px;overflow-y:auto;"></ul>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  window.TECHSCAN_CONFIG = {
    CHART_JS_LOCAL: "{{ url_for('static', filename='js/vendor/chart.umd.min.js') }}",
    STATS_AUTO_REFRESH: "{{ config.get('STATS_AUTO_REFRESH', 'false') | lower }}",
    STATS_AUTO_REFRESH_INTERVAL_MS: "{{ config.get('STATS_AUTO_REFRESH_INTERVAL_MS', '300000') | int }}"
  };
</script>
<script src="{{ url_for('static', filename='js/stats.js') }}"></script>
{% endblock %}