{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">

  <section class="hero-intro" style="padding:1.5rem 0 1rem; text-align:center;">
    <h1 class="hero-title"
      style="font-size:clamp(2rem,5vw,3rem); font-weight:700; background:linear-gradient(92deg,#34d399,#22d3ee 55%,#60a5fa); -webkit-background-clip:text; background-clip:text; color:transparent;">
      System Dashboard
    </h1>
    <p class="hero-lead" style="max-width:800px;margin:0 auto;">
      Monitor system performance, scan statistics, and technology trends.{% if config.get('STATS_AUTO_REFRESH') %}
      Auto-refresh: {{ (config.get('STATS_AUTO_REFRESH_INTERVAL_MS', 300000)|int / 60000)|round|int }} min{% else %}
      Press Ctrl+F5 to refresh.{% endif %}
    </p>
  </section>

  <div class="dashboard-wrapper"
    style="display:flex;flex-direction:column;align-items:center;gap:1rem;margin-top:1rem;">

    <!-- ðŸŸ¢ Header Summary -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;">
        <div class="mini-card">
          <div class="mini-label">Total Scans</div>
          <div class="mini-value" id="total-scans">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Total Domains</div>
          <div class="mini-value" id="total-domains">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Total Payload (All Time)</div>
          <div class="mini-value mini-value-small" id="total-payload">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Avg Duration (s)</div>
          <div class="mini-value" id="avg-duration">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Uptime</div>
          <div class="mini-value" id="uptime">-</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Last Scan</div>
          <div class="mini-value mini-value-small" id="last-scan">-</div>
        </div>
      </div>
      <div id="system-health" style="display:flex;gap:1rem;margin-top:.8rem;justify-content:center;">
        <span class="health-tag" id="redis-status">Redis: -</span>
        <span class="health-tag" id="db-status">DB: -</span>
        <span class="health-tag" id="queue-status">Queue: -</span>
      </div>
    </div>

    <!-- ï¿½ Payload Footprint -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <div
        style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.8rem;">
        <h3 style="margin:0;font-size:1rem;">Payload Footprint</h3>
        <span class="small-note" style="font-size:0.6rem;opacity:0.7;">Averages computed from completed scans</span>
      </div>
      <div class="payload-grid">
        <div class="payload-card">
          <div class="payload-label">Avg 24h</div>
          <div class="payload-value" id="payload-daily">-</div>
        </div>
        <div class="payload-card">
          <div class="payload-label">Avg 7d</div>
          <div class="payload-value" id="payload-weekly">-</div>
        </div>
        <div class="payload-card">
          <div class="payload-label">Avg 30d</div>
          <div class="payload-value" id="payload-monthly">-</div>
        </div>
      </div>
    </div>

    <!-- ï¿½ðŸ“Š Performance -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <h3 style="margin-bottom:1rem;">Scan Performance</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;align-items:start;">
        <div class="chart-container">
          <h4 class="chart-title">Throughput (scan/hour)</h4>
          <div style="position:relative;height:200px;width:100%;">
            <canvas id="throughputChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <h4 class="chart-title">Average Confidence Score</h4>
          <div
            style="position:relative;height:200px;width:100%;display:flex;align-items:center;justify-content:center;">
            <div id="confidence-display" style="text-align:center;">
              <div style="font-size:3rem;font-weight:700;color:#60a5fa;" id="confidence-value">-</div>
              <div class="confidence-label">Overall Confidence</div>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <h4 class="chart-title">Result Breakdown</h4>
          <div style="position:relative;height:200px;width:100%;">
            <canvas id="resultPie"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ðŸ§  Top Technologies -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <h3>Top 10 Technologies</h3>
      <table class="tech-table table-glass table-glass--compact" style="width:100%;margin-top:.5rem;font-size:0.7rem;">
        <thead>
          <tr style="text-align:left;">
            <th style="width:10%;">#</th>
            <th style="width:50%;">Technology</th>
            <th style="width:25%;">Category</th>
            <th style="width:15%;text-align:right;">Count</th>
          </tr>
        </thead>
        <tbody id="top-tech-body"></tbody>
      </table>
    </div>

    <!-- ðŸ§© Categories -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <h3>Top 10 Categories</h3>
      <table class="tech-table table-glass table-glass--compact" style="width:100%;margin-top:.5rem;font-size:0.7rem;">
        <thead>
          <tr style="text-align:left;">
            <th style="width:10%;">#</th>
            <th style="width:70%;">Category</th>
            <th style="width:20%;text-align:right;">Count</th>
          </tr>
        </thead>
        <tbody id="top-cat-body"></tbody>
      </table>
    </div>

    <!-- ðŸ“Š Category Classification -->
    <div class="glass-card" style="max-width:1100px;width:100%;padding:1rem;">
      <h3 style="margin-bottom:1rem;">Category Classification</h3>
      <div class="carousel-container" id="carousel-container"
        style="overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;">
        <div class="carousel-track" id="category-charts-container" style="display:flex;gap:1.5rem;padding:0.5rem 0;">
          <!-- Pie charts will be dynamically inserted here -->
        </div>
      </div>
    </div>

  </div>

  <!-- ðŸªŸ Modal for Technology Domains -->
  <div id="techModal" class="modal hidden">
    <div class="tech-modal-panel">
      <div class="tech-modal-header">
        <div>
          <p class="tech-modal-label">Technology</p>
          <h3 id="modal-tech-name">Technology</h3>
          <p id="modal-category" class="modal-subtitle"></p>
        </div>
        <div class="tech-modal-actions">
          <a id="tech-drill-link" class="secondary outline" target="_blank" rel="noopener">Open Explorer</a>
          <button id="copy-tech-btn" class="secondary outline" type="button">Copy Name</button>
          <button onclick="closeTechModal()" class="ghost icon" aria-label="Close">&times;</button>
        </div>
      </div>
      <div class="tech-modal-metrics">
        <div class="metric-card">
          <span class="metric-label">Usage Count</span>
          <span class="metric-value" id="modal-tech-usage">-</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Categories</span>
          <span class="metric-value" id="modal-tech-categories">-</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Share of Top Stack</span>
          <span class="metric-value" id="modal-tech-share">-</span>
        </div>
      </div>
      <section class="tech-modal-body">
        <header class="tech-modal-body-header">
          <h4>Websites using this technology</h4>
          <div class="tech-modal-filter">
            <input id="modal-domain-search" type="search" placeholder="Filter domains..." />
            <span id="modal-domain-count" class="small">0 domains</span>
          </div>
        </header>
        <ul id="modal-domains-list" class="domain-chip-list"></ul>
      </section>
    </div>
  </div>

  <!-- ðŸªŸ Modal for Category Chart with side-by-side layout -->
  <div id="categoryModal" class="modal hidden">
    <div style="display:flex;gap:1rem;margin:5rem auto 2rem;max-width:95%;max-height:70vh;">
      <!-- Left: Category Technologies -->
      <div class="modal-content glass-card" style="flex:1;max-width:700px;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h3 id="modal-cat-name" style="margin:0;">Category</h3>
          <button onclick="closeCategoryModal()" class="modal-close-btn">Close</button>
        </div>
        <div style="position:relative;height:250px;margin-bottom:1rem;">
          <canvas id="categoryTechChart"></canvas>
        </div>
        <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">Technologies in this category:</h4>
        <table class="tech-table" style="width:100%;">
          <thead>
            <tr style="text-align:left;">
              <th>Technology</th>
              <th style="text-align:right;">Usage Count</th>
            </tr>
          </thead>
          <tbody id="modal-cat-tech-body"></tbody>
        </table>
      </div>

      <!-- Right: Tech Domains (hidden initially) -->
      <div id="sideTechModal" class="modal-content glass-card"
        style="flex:1;max-width:500px;overflow-y:auto;display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <div>
            <h3 id="side-modal-tech-name" style="margin:0;font-size:1.1rem;">Technology</h3>
            <p id="side-modal-category" class="modal-subtitle-small"></p>
          </div>
          <button onclick="closeSideTechModal()" class="modal-close-btn-small">âœ•</button>
        </div>
        <h4 style="margin-bottom:0.5rem;font-size:0.9rem;">Websites using this technology:</h4>
        <ul id="side-modal-domains-list" style="list-style:none;padding:0;max-height:500px;overflow-y:auto;"></ul>
      </div>
    </div>
  </div>

</div>

{% endblock %}

{% block scripts %}
<script>
  (function loadChartJs() {
    const LOCAL_SRC = "{{ url_for('static', filename='js/vendor/chart.umd.min.js') }}";
    const CDN_SRC = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js';
    const head = document.head || document.getElementsByTagName('head')[0];
    let isLoaded = false;
    let fallbackQueued = false;

    function markLoaded(origin) {
      const hasChart = typeof window.Chart !== 'undefined';
      if (origin === 'local' && !hasChart) {
        if (!fallbackQueued) {
          fallbackQueued = true;
          console.warn('[stats] Local Chart.js loaded but window.Chart missing; attempting CDN fallback.');
          inject(CDN_SRC, 'cdn');
        }
        return;
      }
      if (!hasChart) {
        if (origin === 'cdn') {
          console.error('[stats] Chart.js CDN loaded but window.Chart still undefined.');
          isLoaded = true; // prevent infinite retry loop
        }
        return;
      }
      if (isLoaded) return;
      isLoaded = true;
      window.__chartJsOrigin = origin;
      window.dispatchEvent(new Event('chartjs:ready'));
    }

    function inject(src, origin) {
      if (isLoaded) return null;
      const script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.onload = () => markLoaded(origin);
      script.onerror = () => {
        if (origin === 'local' && !fallbackQueued) {
          fallbackQueued = true;
          console.warn('[stats] Local Chart.js failed; attempting CDN fallback.');
          inject(CDN_SRC, 'cdn');
        } else if (origin === 'cdn') {
          console.error('[stats] Chart.js failed to load from both local bundle and CDN fallback.');
        }
      };
      head.appendChild(script);
      return script;
    }

    inject(LOCAL_SRC, 'local');

    setTimeout(() => {
      if (typeof window.Chart !== 'undefined') { return; }
      if (!fallbackQueued) {
        fallbackQueued = true;
        console.warn('[stats] Chart.js still unavailable; attempting CDN fallback.');
        inject(CDN_SRC, 'cdn');
      }
    }, 5000);
  })();
</script>
<script>
  const CATEGORY_TITLE_OVERRIDES = {
    // JavaScript
    'javascript libraries': 'JavaScript Libraries',
    'javascript library': 'JavaScript Libraries',
    'js libraries': 'JavaScript Libraries',
    'javascript frameworks': 'JavaScript Frameworks',
    'javascript framework': 'JavaScript Frameworks',
    'js frameworks': 'JavaScript Frameworks',
    'js framework': 'JavaScript Frameworks',

    // Web Frameworks
    'web frameworks': 'Web Frameworks',
    'web framework': 'Web Frameworks',
    'frameworks': 'Web Frameworks',

    // UI/CSS
    'ui frameworks': 'UI Frameworks',
    'ui framework': 'UI Frameworks',
    'css frameworks': 'CSS Frameworks',
    'css framework': 'CSS Frameworks',
    'css': 'CSS Frameworks',

    // CMS
    'content management system': 'CMS',
    'content management systems': 'CMS',
    'content management': 'CMS',
    'cms': 'CMS',

    // Programming Languages
    'programming languages': 'Programming Languages',
    'programming language': 'Programming Languages',
    'languages': 'Programming Languages',

    // E-commerce
    'e-commerce': 'E-commerce',
    'ecommerce': 'E-commerce',
    'e-commerce platforms': 'E-commerce',
    'ecommerce platforms': 'E-commerce',

    // Analytics
    'analytics': 'Analytics',
    'web analytics': 'Analytics',
    'site analytics': 'Analytics',

    // Tag Managers
    'tag managers': 'Tag Managers',
    'tag manager': 'Tag Managers',

    // CDN
    'cdn': 'CDN',
    'cdn providers': 'CDN',
    'content delivery network': 'CDN',

    // Web Servers
    'web servers': 'Web Servers',
    'web server': 'Web Servers',
    'servers': 'Web Servers',

    // JavaScript Runtimes
    'javascript runtimes': 'JavaScript Runtimes',
    'javascript runtime': 'JavaScript Runtimes',
    'js runtimes': 'JavaScript Runtimes',
    'runtime': 'JavaScript Runtimes',

    // Reverse Proxies
    'reverse proxies': 'Reverse Proxies',
    'reverse proxy': 'Reverse Proxies',

    // Databases
    'databases': 'Databases',
    'database': 'Databases',
    'database management': 'Databases',

    // Security
    'security': 'Security',
    'ssl/tls certificate authorities': 'Security',
    'ssl': 'Security',

    // SEO
    'seo': 'SEO',
    'search engine optimization': 'SEO',

    // WordPress
    'wordpress plugins': 'WordPress Plugins',
    'wordpress plugin': 'WordPress Plugins',
    'wordpress themes': 'WordPress Themes',
    'wordpress theme': 'WordPress Themes',

    // Font/Icons
    'font scripts': 'Font Scripts',
    'icon sets': 'Icon Sets',
    'fonts': 'Font Scripts',
    'icons': 'Icon Sets',

    // Marketing
    'marketing automation': 'Marketing Automation',
    'marketing': 'Marketing Automation',
    'advertising': 'Advertising',
    'a/b testing': 'A/B Testing',

    // Miscellaneous
    'miscellaneous': 'Miscellaneous',
    'misc': 'Miscellaneous',
    'other': 'Miscellaneous',

    // Hosting
    'hosting': 'Hosting',
    'hosting services': 'Hosting',
    'paas': 'Hosting',

    // Live Chat
    'live chat': 'Live Chat',
    'chat': 'Live Chat',

    // Video
    'video players': 'Video Players',
    'video': 'Video Players',

    // Rich Text
    'rich text editors': 'Rich Text Editors',
    'text editors': 'Rich Text Editors',

    // PWA
    'progressive web apps': 'Progressive Web Apps',
    'pwa': 'Progressive Web Apps'
  };

  const CATEGORY_UPPER_TOKENS = new Set(['api', 'cdn', 'cms', 'css', 'dns', 'erp', 'http', 'https', 'id', 'pdf', 'php', 'redis', 'rest', 'seo', 'sql', 'ssl', 'tls', 'ui', 'ux']);

  function buildTimeseriesFallback() {
    const hours = [];
    const now = new Date();
    for (let i = 11; i >= 0; i--) {
      const slot = new Date(now.getTime() - i * 60 * 60 * 1000);
      const hourVal = slot.getHours();
      hours.push(`${hourVal.toString().padStart(2, '0')}:00`);
    }
    const sampleScans = [18, 22, 27, 31, 36, 42, 45, 40, 34, 30, 26, 22];
    const sampleConfidence = [83.2, 83.9, 84.6, 85.1, 85.8, 86.3, 86.6, 86.2, 85.7, 85.1, 84.6, 84.0];
    return {
      timestamps: hours,
      scans: sampleScans.slice(0, hours.length),
      avg_conf: sampleConfidence.slice(0, hours.length),
      success: 820,
      timeout: 145,
      error: 35
    };
  }

  function normalizeTimeseries(raw) {
    const fallback = buildTimeseriesFallback();
    if (!raw || typeof raw !== 'object') {
      return fallback;
    }
    const toArray = (value) => Array.isArray(value) ? value.slice() : [];
    let timestamps = toArray(raw.timestamps).map(v => String(v || '').trim()).filter(Boolean);
    if (!timestamps.length) {
      timestamps = fallback.timestamps.slice();
    }
    let scans = toArray(raw.scans).map(v => Number(v)).filter(v => Number.isFinite(v));
    if (!scans.length) {
      scans = fallback.scans.slice();
    }
    if (scans.length !== timestamps.length) {
      const len = Math.min(scans.length, timestamps.length);
      if (len === 0) {
        timestamps = fallback.timestamps.slice();
        scans = fallback.scans.slice();
      } else {
        timestamps = timestamps.slice(-len);
        scans = scans.slice(-len);
      }
    }
    let avgConf = toArray(raw.avg_conf).map(v => Number(v)).filter(v => Number.isFinite(v));
    if (!avgConf.length) {
      avgConf = fallback.avg_conf.slice(0, timestamps.length);
    }
    if (avgConf.length > timestamps.length) {
      avgConf = avgConf.slice(-timestamps.length);
    } else if (avgConf.length < timestamps.length) {
      const missing = timestamps.length - avgConf.length;
      const lastVal = avgConf.length ? avgConf[avgConf.length - 1] : fallback.avg_conf[0];
      for (let i = 0; i < missing; i++) {
        avgConf.push(lastVal);
      }
    }
    const toNumber = (value, fallbackValue) => {
      const num = Number(value);
      return Number.isFinite(num) && num >= 0 ? num : fallbackValue;
    };
    return {
      timestamps,
      scans,
      avg_conf: avgConf,
      success: toNumber(raw.success, fallback.success),
      timeout: toNumber(raw.timeout, fallback.timeout),
      error: toNumber(raw.error, fallback.error)
    };
  }

  window._lastTimeseries = window._lastTimeseries || buildTimeseriesFallback();
  window._topTechUsageTotal = window._topTechUsageTotal || 0;

  let chartWarningIssued = false;
  function ensureChartLib() {
    if (typeof window.Chart === 'undefined') {
      if (!chartWarningIssued) {
        console.warn('[stats] Chart.js is not loaded; chart rendering skipped.');
        chartWarningIssued = true;
      }
      return false;
    }
    return true;
  }

  function whenChartReady(callback) {
    if (typeof window.Chart !== 'undefined') {
      callback();
      return;
    }
    const handler = () => {
      window.removeEventListener('chartjs:ready', handler);
      callback();
    };
    window.addEventListener('chartjs:ready', handler);
  }

  function escapeHtml(value) {
    return String(value ?? '').replace(/[&<>"']/g, function (ch) {
      switch (ch) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  }

  function normalizeCategoryKey(label) {
    if (label === undefined || label === null) return '';
    const lowered = String(label).trim().toLowerCase();
    // Check if there's an override - if so, return the canonical form's key
    const override = CATEGORY_TITLE_OVERRIDES[lowered];
    if (override) {
      // Return the lowercase of the canonical form for consistent grouping
      return override.toLowerCase();
    }
    return lowered;
  }

  function formatCategoryLabel(label) {
    if (label === undefined || label === null) return '';
    const trimmed = String(label).replace(/\s+/g, ' ').trim();
    if (!trimmed) return '';
    const override = CATEGORY_TITLE_OVERRIDES[normalizeCategoryKey(trimmed)];
    if (override) return override;
    const words = trimmed.toLowerCase().split(' ');
    const formatted = words.map(word => {
      if (CATEGORY_UPPER_TOKENS.has(word)) return word.toUpperCase();
      if (word.length <= 2) return word.toUpperCase();
      return word.charAt(0).toUpperCase() + word.slice(1);
    });
    return formatted.join(' ');
  }

  function formatBytes(value) {
    if (value === null || value === undefined) return '';
    let bytes = Number(value);
    if (!Number.isFinite(bytes)) return '';
    if (bytes < 0) return '';
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let unitIndex = 0;
    while (bytes >= 1024 && unitIndex < units.length - 1) {
      bytes /= 1024;
      unitIndex += 1;
    }
    const precision = bytes >= 10 ? 1 : 2;
    return `${bytes.toFixed(precision)} ${units[unitIndex]}`;
  }

  function updatePayloadMetric(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    if (value === null || value === undefined || !Number.isFinite(Number(value))) {
      el.textContent = 'â€“';
      el.removeAttribute('title');
      return;
    }
    const formatted = formatBytes(value);
    if (formatted) {
      el.textContent = formatted;
      el.title = `${Math.round(Number(value))} bytes`;
    } else {
      el.textContent = '0 B';
      el.title = '';
    }
  }

  function normalizeCategories(raw) {
    if (!raw) return [];
    let values = [];
    if (Array.isArray(raw)) {
      values = raw.flatMap(item => {
        if (typeof item === 'string') return item;
        if (item && typeof item === 'object') {
          if (typeof item.name === 'string') return item.name;
          if (typeof item.category === 'string') return item.category;
          return Object.values(item).filter(v => typeof v === 'string');
        }
        return [];
      });
    } else if (typeof raw === 'string') {
      values = raw.split(',');
    } else if (typeof raw === 'object') {
      if (typeof raw.name === 'string') {
        values = [raw.name];
      } else if (typeof raw.category === 'string') {
        values = [raw.category];
      } else {
        values = Object.values(raw).filter(v => typeof v === 'string');
      }
    }
    const normalized = values
      .map(v => formatCategoryLabel(v))
      .filter(Boolean);
    return normalized.filter((val, idx) => normalized.indexOf(val) === idx);
  }

  const UNCATEGORIZED_LABEL = 'Uncategorized';

  // Fallback categories for common technologies missing categories in database
  const TECH_CATEGORY_FALLBACK = {
    // JavaScript Libraries
    'jquery': 'JavaScript Libraries',
    'jquery ui': 'JavaScript Libraries',
    'jquery migrate': 'JavaScript Libraries',
    'jquery cdn': 'JavaScript Libraries',
    'react': 'JavaScript Libraries',
    'vue.js': 'JavaScript Libraries',
    'angular': 'JavaScript Frameworks',
    'angularjs': 'JavaScript Frameworks',
    'alpine.js': 'JavaScript Libraries',
    'moment.js': 'JavaScript Libraries',
    'lodash': 'JavaScript Libraries',
    'underscore.js': 'JavaScript Libraries',
    'axios': 'JavaScript Libraries',
    'core-js': 'JavaScript Libraries',
    'swiper': 'JavaScript Libraries',
    'slick': 'JavaScript Libraries',
    'owl carousel': 'JavaScript Libraries',
    'datatables': 'JavaScript Libraries',
    'marked': 'JavaScript Libraries',
    'highlight.js': 'JavaScript Libraries',
    'prism': 'JavaScript Libraries',

    // JavaScript Frameworks (NOT just libraries, NOT web servers, NOT programming languages)
    'next.js': 'JavaScript Frameworks',
    'nuxt.js': 'JavaScript Frameworks',
    'nuxt': 'JavaScript Frameworks',
    'gatsby': 'JavaScript Frameworks',
    'svelte': 'JavaScript Frameworks',
    'sveltekit': 'JavaScript Frameworks',
    'remix': 'JavaScript Frameworks',
    'solid': 'JavaScript Frameworks',
    'astro': 'JavaScript Frameworks',
    'express': 'JavaScript Frameworks',
    'express.js': 'JavaScript Frameworks',
    'koa': 'JavaScript Frameworks',
    'fastify': 'JavaScript Frameworks',
    'hapi': 'JavaScript Frameworks',
    'nest.js': 'JavaScript Frameworks',
    'nestjs': 'JavaScript Frameworks',
    'adonis': 'JavaScript Frameworks',
    'meteor': 'JavaScript Frameworks',
    'ember.js': 'JavaScript Frameworks',
    'ember': 'JavaScript Frameworks',
    'backbone.js': 'JavaScript Libraries',
    'backbone': 'JavaScript Libraries',
    'knockout.js': 'JavaScript Libraries',
    'knockout': 'JavaScript Libraries',
    'polymer': 'JavaScript Libraries',
    'lit': 'JavaScript Libraries',
    'preact': 'JavaScript Libraries',
    'inferno': 'JavaScript Libraries',
    'mithril': 'JavaScript Libraries',
    'htmx': 'JavaScript Libraries',
    'stimulus': 'JavaScript Libraries',
    'turbo': 'JavaScript Libraries',
    'hotwire': 'JavaScript Libraries',

    // UI/CSS Frameworks
    'bootstrap': 'UI Frameworks',
    'tailwind css': 'CSS Frameworks',
    'foundation': 'UI Frameworks',
    'bulma': 'CSS Frameworks',
    'materialize css': 'UI Frameworks',
    'semantic ui': 'UI Frameworks',

    // Font/Icons
    'font awesome': 'Font Scripts',
    'google font api': 'Font Scripts',
    'material icons': 'Font Scripts',
    'bootstrap icons': 'Font Scripts',
    'feather icons': 'Icon Sets',
    'ionicons': 'Icon Sets',

    // WordPress
    'wpml': 'WordPress Plugins',
    'wordpress multilingual plugin (wpml)': 'WordPress Plugins',
    'slider revolution': 'WordPress Plugins',
    'elementor': 'WordPress Plugins',
    'yoast seo': 'WordPress Plugins',
    'contact form 7': 'WordPress Plugins',
    'woocommerce': 'E-commerce',

    // Security
    'sucuri': 'Security',
    'bitninja': 'Security',
    'imunify360': 'Security',
    'imunify360-webshield': 'Security',
    'cloudflare': 'CDN',

    // Analytics/Marketing
    'google analytics': 'Analytics',
    'google tag manager': 'Tag Managers',
    'facebook pixel': 'Advertising',
    'hotjar': 'Analytics',
    'tableau': 'Analytics',

    // Servers
    'nginx': 'Web Servers',
    'apache': 'Web Servers',
    'litespeed': 'Web Servers',
    'tengine': 'Web Servers',
    'iis': 'Web Servers',
    'caddy': 'Web Servers',

    // Programming Languages (actual languages only)
    'php': 'Programming Languages',
    'python': 'Programming Languages',
    'ruby': 'Programming Languages',
    'java': 'Programming Languages',
    'c#': 'Programming Languages',
    'perl': 'Programming Languages',
    'lua': 'Programming Languages',

    // JavaScript Runtimes (NOT programming languages)
    'node.js': 'JavaScript Runtimes',
    'deno': 'JavaScript Runtimes',
    'bun': 'JavaScript Runtimes',

    // Build Tools & Transpilers
    'typescript': 'JavaScript Libraries',
    'babel': 'JavaScript Libraries',
    'webpack': 'JavaScript Libraries',
    'vite': 'JavaScript Libraries',
    'esbuild': 'JavaScript Libraries',
    'parcel': 'JavaScript Libraries',
    'rollup': 'JavaScript Libraries',
    'go': 'Programming Languages',

    // CMS
    'wordpress': 'CMS',
    'joomla': 'CMS',
    'drupal': 'CMS',
    'magento': 'E-commerce',
    'shopify': 'E-commerce',

    // Databases
    'mysql': 'Databases',
    'postgresql': 'Databases',
    'mongodb': 'Databases',
    'redis': 'Databases',

    // Video
    'youtube': 'Video Players',
    'vimeo': 'Video Players',
    'video.js': 'Video Players',

    // Other common
    'esf': 'Security',
    'ghs': 'Hosting',
    'awselb': 'Load Balancers',
    'bakso': 'Miscellaneous'
  };

  // Helper: check if a technology name has a known fallback category
  function hasFallbackCategory(techName) {
    if (!techName) return false;
    return !!TECH_CATEGORY_FALLBACK[String(techName).toLowerCase()];
  }

  // Helper: get fallback category for a technology
  function getFallbackCategory(techName) {
    if (!techName) return null;
    return TECH_CATEGORY_FALLBACK[String(techName).toLowerCase()] || null;
  }

  function normalizeTechEntry(item) {
    const techName = item && (item.tech || item.name) ? String(item.tech || item.name) : '-';
    let categories = normalizeCategories(item ? (item.categories ?? item.category) : null);

    // ALWAYS override category if we have a correction for this tech
    // This fixes wrong categories from Wappalyzer (e.g., Node.js in "Programming Languages")
    const overrideCat = TECH_CATEGORY_FALLBACK[techName.toLowerCase()];
    if (overrideCat) {
      categories = [overrideCat];
    } else if (!categories.length) {
      // Only use Uncategorized if no override and no existing categories
      categories = [UNCATEGORIZED_LABEL];
    }

    return Object.assign({}, item, {
      tech: techName,
      categories,
      category: categories[0] || UNCATEGORIZED_LABEL,
      count: Number(item && item.count) || 0
    });
  }

  function normalizeCategoryEntry(item) {
    const raw = item && (item.rawCategory || item.category || item.name) ? String(item.rawCategory || item.category || item.name) : '';
    const formatted = formatCategoryLabel(raw) || raw;
    return Object.assign({}, item, {
      rawCategory: raw,
      category: formatted,
      count: Number(item && item.count) || 0
    });
  }

  function deriveCategorySummary(categories, techs) {
    const map = new Map();

    function ensureEntry(rawLabel) {
      const key = normalizeCategoryKey(rawLabel);
      if (!key) return null;
      let entry = map.get(key);
      const formatted = formatCategoryLabel(rawLabel) || rawLabel;
      if (!entry) {
        entry = {
          key,
          label: formatted,
          raw: rawLabel,
          primaryCount: 0,
          techAggregate: 0,
          techCounts: new Map()
        };
        map.set(key, entry);
      } else if (formatted && formatted.length >= entry.label.length && entry.label !== formatted) {
        entry.label = formatted;
      }
      if (!entry.raw && rawLabel) entry.raw = rawLabel;
      return entry;
    }

    (categories || []).forEach(cat => {
      const rawLabel = cat && (cat.rawCategory || cat.category);
      const entry = ensureEntry(rawLabel);
      if (!entry) return;
      const count = Number(cat && cat.count) || 0;
      if (count > entry.primaryCount) {
        entry.primaryCount = count;
      }
    });

    (techs || []).forEach(tech => {
      let catList = normalizeCategories(tech ? (tech.categories || tech.category) : null);
      const techName = tech && (tech.tech || tech.name) ? String(tech.tech || tech.name) : null;
      const techCount = Number(tech && tech.count) || 0;

      // ALWAYS apply category override if we have one (fixes wrong categories from Wappalyzer)
      if (techName) {
        const overrideCat = TECH_CATEGORY_FALLBACK[techName.toLowerCase()];
        if (overrideCat) {
          catList = [overrideCat];
        }
      }

      if (!catList.length) return;
      catList.forEach(label => {
        const entry = ensureEntry(label);
        if (!entry) return;
        entry.techAggregate += techCount || 1;
        if (techName) {
          const prev = entry.techCounts.get(techName) || 0;
          entry.techCounts.set(techName, Math.max(prev, techCount));
        }
      });
    });

    return Array.from(map.values())
      .map(entry => {
        const totalCount = entry.primaryCount || entry.techAggregate;
        const techsSorted = Array.from(entry.techCounts.entries())
          .sort((a, b) => (b[1] || 0) - (a[1] || 0))
          .slice(0, 5)
          .map(([name, count]) => ({ name, count }));
        return {
          category: entry.label,
          rawCategory: entry.raw || entry.label,
          count: totalCount,
          techs: techsSorted
        };
      })
      .sort((a, b) => (b.count || 0) - (a.count || 0));
  }

  async function fetchStats() {
    let data;
    let timeseriesPayload = null;
    try {
      const res = await fetch('/api/stats', { cache: 'no-store' });
      data = await res.json();
      localStorage.setItem('techscan_lastStats', JSON.stringify(data));
    } catch (err) {
      console.error('stats fetch failed: using cached snapshot', err);
      data = JSON.parse(localStorage.getItem('techscan_lastStats') || '{}');
    }

    try {
      const perfRes = await fetch('/api/performance_timeseries', { cache: 'no-store' });
      if (perfRes && perfRes.ok) {
        timeseriesPayload = await perfRes.json();
      }
    } catch (err) {
      console.warn('performance timeseries fetch failed; falling back to sample data', err);
    }

    window._lastTimeseries = normalizeTimeseries(timeseriesPayload);

    if (!data) return;

    const payloadStats = data.payload_size_stats || {};
    updatePayloadMetric('payload-daily', payloadStats.avg_daily_bytes);
    updatePayloadMetric('payload-weekly', payloadStats.avg_weekly_bytes);
    updatePayloadMetric('payload-monthly', payloadStats.avg_monthly_bytes);

    const normalizedTechs = (data.top_technologies || []).map(normalizeTechEntry);
    const normalizedCategories = (data.top_categories || []).map(normalizeCategoryEntry);
    const categorySummary = deriveCategorySummary(normalizedCategories, normalizedTechs);
    const totalTopUsage = normalizedTechs.reduce((sum, entry) => sum + (Number(entry.count) || 0), 0);

    window._lastStats = Object.assign({}, data, {
      top_technologies: normalizedTechs,
      top_categories: normalizedCategories,
      category_summary: categorySummary
    });
    window._topTechUsageTotal = totalTopUsage;

    // Total Scans
    document.getElementById('total-scans').textContent = data.scans_total || 0;

    // Total Domains & Unique Domains (fallback to available values)
    const totalDomains = (data && (data.domains_total ?? data.total_domains ?? data.unique_domains)) || 0;
    const totalDomainsEl = document.getElementById('total-domains');
    if (totalDomainsEl) totalDomainsEl.textContent = totalDomains;
    updatePayloadMetric('total-payload', data.total_payload_bytes);

    // Last Scan - format dengan tanggal lengkap
    if (data.last_scan) {
      const lastScanDate = new Date(data.last_scan.finished_at * 1000);
      // Format: "Nov 3, 14:23:45"
      document.getElementById('last-scan').textContent = lastScanDate.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    } else {
      document.getElementById('last-scan').textContent = '-';
    }

    // Average Duration - gunakan avg_duration_ms atau avg_duration_ms_24h
    const avgDurMs = data.avg_duration_ms || data.avg_duration_ms_24h || 0;
    const avgDurSeconds = Number(avgDurMs) / 1000;
    const hasDuration = Number.isFinite(avgDurSeconds) && avgDurSeconds > 0;
    document.getElementById('avg-duration').textContent = hasDuration ? `${avgDurSeconds.toFixed(2)} s` : '-';

    // Uptime - format realtime (days, hours, minutes, seconds)
    if (data.uptime_seconds) {
      document.getElementById('uptime').textContent = formatUptime(data.uptime_seconds);
      // Update uptime setiap detik
      startUptimeCounter(data.uptime_seconds);
    } else {
      document.getElementById('uptime').textContent = '-';
    }

    // system health fallback
    try {
      const health = await fetch('/api/system_health', { cache: 'no-store' }).then(r => r.json());
      ['redis', 'db', 'queue'].forEach(k => {
        const el = document.getElementById(`${k}-status`);
        const st = health[k] || 'unknown';
        el.textContent = `${k.toUpperCase()}: ${st}`;
        el.style.color = st === 'ok' ? '#22c55e' : (st === 'warn' ? '#f59e0b' : '#ef4444');
      });
    } catch (e) { }

    console.log("Top tech:", normalizedTechs);
    console.log("Top categories:", normalizedCategories);

    renderTechTable(normalizedTechs);
    renderCategoryTable(normalizedCategories);
    whenChartReady(() => {
      renderPerformanceCharts(window._lastStats, window._lastTimeseries);
      renderCategoryClassification(window._lastStats.category_summary);
    });
  }

  function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);

    const parts = [];
    if (days > 0) parts.push(`${days}d`);
    if (hours > 0) parts.push(`${hours}h`);
    if (minutes > 0) parts.push(`${minutes}m`);
    parts.push(`${secs}s`);

    return parts.join(' ');
  }

  let uptimeStartSeconds = 0;
  let uptimeInterval = null;

  function startUptimeCounter(initialSeconds) {
    uptimeStartSeconds = initialSeconds;
    const startTime = Date.now();

    // Clear interval sebelumnya jika ada
    if (uptimeInterval) clearInterval(uptimeInterval);

    // Update setiap detik
    uptimeInterval = setInterval(() => {
      const elapsed = (Date.now() - startTime) / 1000;
      const currentUptime = uptimeStartSeconds + elapsed;
      document.getElementById('uptime').textContent = formatUptime(currentUptime);
    }, 1000);
  }

  function renderTechTable(techs) {
    const tbody = document.getElementById('top-tech-body');
    tbody.innerHTML = '';
    const top10 = techs.slice(0, 10);
    top10.forEach((t, idx) => {
      const tr = document.createElement('tr');
      const categories = Array.isArray(t.categories) ? t.categories : normalizeCategories(t.categories || t.category);
      const categoryDisplay = categories.length ? categories.join(', ') : '-';
      tr.innerHTML = `<td class="table-index">${idx + 1}</td><td style="font-weight:600;">${t.tech}</td><td class="table-category">${categoryDisplay}</td><td style="text-align:right;font-weight:600;">${t.count || 0}</td>`;
      tr.addEventListener('click', () => openTechModal(t));
      tr.style.cursor = 'pointer';
      tbody.appendChild(tr);
    });
  }

  function renderCategoryTable(categories) {
    const tbody = document.getElementById('top-cat-body');
    tbody.innerHTML = '';
    const top10 = categories.slice(0, 10);
    top10.forEach((c, idx) => {
      const tr = document.createElement('tr');
      const displayLabel = c.category || '-';
      tr.innerHTML = `<td class="table-index">${idx + 1}</td><td style="font-weight:600;">${displayLabel}</td><td style="text-align:right;font-weight:600;">${c.count || 0}</td>`;
      tr.addEventListener('click', () => openCategoryModal(c.rawCategory || c.category));
      tr.style.cursor = 'pointer';
      tbody.appendChild(tr);
    });
  }

  let techModalDomains = [];

  function renderTechModalDomains(domains) {
    const listNode = document.getElementById('modal-domains-list');
    const countNode = document.getElementById('modal-domain-count');
    if (!listNode) return;
    const safeList = Array.isArray(domains) ? domains : [];
    if (!safeList.length) {
      listNode.innerHTML = '<li class="loading-text">No domains found</li>';
    } else {
      listNode.innerHTML = safeList.map(domain => {
        const safe = escapeHtml(domain);
        return `<li><a href="https://${safe}" target="_blank" rel="noopener">${safe}</a><span class="mono" style="opacity:0.6;font-size:0.7rem;">open</span></li>`;
      }).join('');
    }
    if (countNode) {
      const label = safeList.length === 1 ? 'domain' : 'domains';
      countNode.textContent = `${safeList.length} ${label}`;
    }
  }

  function filterTechModalDomains(term) {
    const normalized = (term || '').trim().toLowerCase();
    if (!normalized) {
      renderTechModalDomains(techModalDomains);
      return;
    }
    const filtered = techModalDomains.filter(domain => domain.toLowerCase().includes(normalized));
    renderTechModalDomains(filtered);
  }

  async function copyTechName() {
    const techNameEl = document.getElementById('modal-tech-name');
    const btn = document.getElementById('copy-tech-btn');
    const value = techNameEl ? (techNameEl.textContent || '').trim() : '';
    if (!value) return;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(value);
      } else {
        const ta = document.createElement('textarea');
        ta.value = value;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
    } catch (err) {
      console.warn('copy failed', err);
    }
    if (btn) {
      const prev = btn.textContent;
      btn.textContent = 'Copied';
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = prev || 'Copy Name';
        btn.disabled = false;
      }, 1200);
    }
  }

  function renderPerformanceCharts(statsData, timeseries) {
    if (!ensureChartLib()) {
      return;
    }
    const fallbackSeries = buildTimeseriesFallback();
    const series = timeseries && Array.isArray(timeseries.timestamps) ? timeseries : fallbackSeries;
    const labels = Array.isArray(series.timestamps) && series.timestamps.length ? series.timestamps : fallbackSeries.timestamps;
    const throughputData = Array.isArray(series.scans) && series.scans.length === labels.length ? series.scans : fallbackSeries.scans;

    const existingThroughputChart = Chart.getChart('throughputChart');
    if (existingThroughputChart) {
      existingThroughputChart.destroy();
    }
    if (labels.length && throughputData.length) {
      makeLineChart('throughputChart', labels, throughputData, 'Scans/Hour', '#22c55e');
    }

    const confidenceSeries = Array.isArray(series.avg_conf)
      ? series.avg_conf.map(v => Number(v)).filter(v => Number.isFinite(v))
      : [];
    let avgConfidence = confidenceSeries.length ? confidenceSeries[confidenceSeries.length - 1] : null;
    if (!Number.isFinite(avgConfidence) && statsData && Number.isFinite(Number(statsData.avg_confidence))) {
      avgConfidence = Number(statsData.avg_confidence);
    }
    if (!Number.isFinite(avgConfidence)) {
      const fallbackAvg = fallbackSeries.avg_conf[fallbackSeries.avg_conf.length - 1] || 0;
      avgConfidence = fallbackAvg;
    }
    const confidenceNode = document.getElementById('confidence-value');
    if (confidenceNode) {
      confidenceNode.textContent = Number.isFinite(avgConfidence) ? avgConfidence.toFixed(1) + '%' : 'â€“';
    }

    const breakdownCounts = [series.success, series.timeout, series.error].map(v => Number.isFinite(Number(v)) ? Number(v) : 0);
    const hasBreakdown = breakdownCounts.some(v => v > 0);
    const pieCounts = hasBreakdown ? breakdownCounts : [fallbackSeries.success, fallbackSeries.timeout, fallbackSeries.error];
    const existingPieChart = Chart.getChart('resultPie');
    if (existingPieChart) {
      existingPieChart.destroy();
    }
    makePieChart('resultPie', ['Success', 'Timeout', 'Error'], pieCounts);
  }

  // Theme helpers for charts
  function getTheme() {
    const isExplicitDark = document.documentElement.classList.contains('dark');
    const isExplicitLight = document.documentElement.classList.contains('light');
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    const isLight = isExplicitLight || (!isExplicitDark && prefersLight);
    return {
      text: isLight ? '#111' : 'rgba(255,255,255,0.8)',
      grid: isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.08)',
      legend: isLight ? '#222' : 'rgba(255,255,255,0.85)',
      tooltipBg: 'rgba(0,0,0,0.85)',
      tooltipTitle: '#fff',
      tooltipBody: '#fff'
    };
  }

  function makeLineChart(id, labels, data, label, color) {
    if (!ensureChartLib()) return null;
    const canvas = document.getElementById(id);
    if (!canvas) return null;
    const theme = getTheme();
    new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label,
          data,
          borderColor: color,
          backgroundColor: color + '30',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 6,
          pointBackgroundColor: color,
          pointBorderColor: theme.text,
          pointBorderWidth: 1,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: theme.tooltipBg,
            titleColor: theme.tooltipTitle,
            bodyColor: theme.tooltipBody,
            borderColor: color,
            borderWidth: 1,
            padding: 10,
            displayColors: false,
            callbacks: {
              title: function (context) {
                return context[0].label;
              },
              label: function (context) {
                return label + ': ' + context.parsed.y;
              }
            }
          }
        },
        scales: {
          x: {
            display: true,
            grid: {
              color: theme.grid,
              drawBorder: false
            },
            ticks: {
              color: theme.text,
              font: { size: 10, weight: '500' },
              padding: 8
            }
          },
          y: {
            display: true,
            grid: {
              color: theme.grid,
              drawBorder: false
            },
            ticks: {
              color: theme.text,
              font: { size: 10, weight: '500' },
              padding: 8,
              callback: function (value) {
                return Math.round(value);
              }
            },
            beginAtZero: true
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    });
  }
  function makePieChart(id, labels, data) {
    if (!ensureChartLib()) {
      // queue a doughnut chart creation for when Chart.js is ready
      const config = {
        type: 'doughnut',
        data: { labels: labels, datasets: [{ data, backgroundColor: ['#22c55e', '#fbbf24', '#ef4444'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false }
      };
      __enqueueChartCreation({ kind: 'doughnut', id, config });
      return null;
    }
    const theme = getTheme();
    const total = data.reduce((a, b) => a + b, 0);
    const percentages = data.map(v => ((v / total) * 100).toFixed(1) + '%');
    const canvas = document.getElementById(id);
    if (!canvas) return null;
    new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels: labels.map((l, i) => `${l} (${percentages[i]})`),
        datasets: [{
          data,
          backgroundColor: ['#22c55e', '#fbbf24', '#ef4444'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              color: theme.legend,
              font: { size: 10 },
              padding: 8,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: theme.tooltipBg,
            titleColor: theme.tooltipTitle,
            bodyColor: theme.tooltipBody,
            callbacks: {
              label: function (context) {
                return context.label + ': ' + context.parsed;
              }
            }
          }
        }
      }
    });
  }

  function makeBarChart(id, labels, data, color) {
    if (!ensureChartLib()) {
      // queue a horizontal bar chart and assign to `categoryChartInstance` when ready
      __enqueueChartCreation({
        kind: 'bar', id, labels, data, color, label: 'Usage Count', assignTo: 'categoryChartInstance', options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: { x: { grid: { drawBorder: false } }, y: { grid: { display: false } } }
        }
      });
      return null;
    }
    const theme = getTheme();
    const canvas = document.getElementById(id);
    if (!canvas) return null;
    return new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Usage Count',
          data,
          backgroundColor: color,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: theme.tooltipBg,
            titleColor: theme.tooltipTitle,
            bodyColor: theme.tooltipBody,
            padding: 10
          }
        },
        scales: {
          x: {
            display: true,
            grid: {
              color: theme.grid,
              drawBorder: false
            },
            ticks: {
              color: theme.text,
              font: { size: 10 }
            }
          },
          y: {
            display: true,
            grid: {
              display: false
            },
            ticks: {
              color: theme.text,
              font: { size: 11, weight: '500' }
            }
          }
        }
      }
    });
  }

  // ðŸªŸ Modal Functions
  var categoryChartInstance = null;
  var categoryPieCharts = {};

  // Queue for chart creations while Chart.js is still loading
  window.__pendingCharts = window.__pendingCharts || [];
  function __enqueueChartCreation(item) {
    window.__pendingCharts.push(item);
  }
  function __processPendingCharts() {
    if (typeof window.Chart === 'undefined') return;
    const items = window.__pendingCharts.splice(0);
    items.forEach(item => {
      try {
        if (item.kind === 'bar') {
          const ctx = document.getElementById(item.id);
          if (!ctx) return;
          const chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: item.labels, datasets: [{ label: item.label || 'Usage Count', data: item.data, backgroundColor: item.color || '#60a5fa', borderRadius: 4 }] },
            options: item.options || {}
          });
          if (item.assignTo) window[item.assignTo] = chart;
        } else if (item.kind === 'doughnut' || item.kind === 'pie') {
          const ctx = document.getElementById(item.id);
          if (!ctx) return;
          const chart = new Chart(ctx, item.config);
          if (item.assignTo) window[item.assignTo] = chart;
        } else if (item.kind === 'line') {
          const ctx = document.getElementById(item.id);
          if (!ctx) return;
          const chart = new Chart(ctx, item.config);
          if (item.assignTo) window[item.assignTo] = chart;
        }
      } catch (e) {
        console.error('Pending chart creation failed', e, item);
      }
    });
  }
  window.addEventListener('chartjs:ready', __processPendingCharts);
  setTimeout(__processPendingCharts, 100);

  async function openTechModal(tech) {
    const modal = document.getElementById('techModal');
    modal.classList.remove('hidden');
    const techNameEl = document.getElementById('modal-tech-name');
    const categoryLabelEl = document.getElementById('modal-category');
    const categoryValueEl = document.getElementById('modal-tech-categories');
    const usageEl = document.getElementById('modal-tech-usage');
    const shareEl = document.getElementById('modal-tech-share');
    const drillLink = document.getElementById('tech-drill-link');
    const domainSearch = document.getElementById('modal-domain-search');
    const domainsList = document.getElementById('modal-domains-list');
    const domainCount = document.getElementById('modal-domain-count');

    const categories = Array.isArray(tech.categories) ? tech.categories : normalizeCategories(tech.categories || tech.category);
    const categoryLabel = categories.length ? categories.join(', ') : 'Uncategorized';

    if (techNameEl) techNameEl.textContent = tech.tech;
    if (categoryLabelEl) categoryLabelEl.textContent = `Primary: ${categoryLabel}`;
    if (categoryValueEl) categoryValueEl.textContent = categoryLabel;
    if (usageEl) usageEl.textContent = Number(tech.count || 0).toLocaleString('en-US');

    const totalTopUsage = Number(window._topTechUsageTotal) || 0;
    if (shareEl) {
      if (totalTopUsage > 0) {
        const pct = Math.max(0, ((Number(tech.count) || 0) / totalTopUsage) * 100);
        shareEl.textContent = pct.toFixed(1) + '%';
      } else {
        shareEl.textContent = '-';
      }
    }

    if (drillLink) {
      drillLink.href = `/technology?search=${encodeURIComponent(tech.tech)}`;
    }

    techModalDomains = [];
    if (domainsList) domainsList.innerHTML = '<li class="loading-text">Loading domains...</li>';
    if (domainCount) domainCount.textContent = 'Loading...';
    if (domainSearch) {
      domainSearch.value = '';
      domainSearch.disabled = true;
    }

    try {
      const res = await fetch(`/api/tech/${encodeURIComponent(tech.tech)}/domains?t=${Date.now()}`, { cache: 'no-store' });
      const data = await res.json();
      techModalDomains = Array.isArray(data.domains) ? data.domains : [];
      renderTechModalDomains(techModalDomains);
    } catch (e) {
      console.error('Failed to load domains', e);
      if (domainsList) domainsList.innerHTML = '<li class="loading-text">Failed to load domains</li>';
      if (domainCount) domainCount.textContent = '0 domains';
    } finally {
      if (domainSearch) {
        domainSearch.disabled = !techModalDomains.length;
      }
    }
  }

  function closeTechModal() {
    document.getElementById('techModal').classList.add('hidden');
    const domainSearch = document.getElementById('modal-domain-search');
    if (domainSearch) {
      domainSearch.value = '';
      domainSearch.disabled = false;
    }
    techModalDomains = [];
  }

  async function openCategoryModal(categoryName) {
    document.getElementById('categoryModal').classList.remove('hidden');
    document.getElementById('modal-cat-name').textContent = categoryName;

    // RESET side modal completely - clear all data
    const sideModal = document.getElementById('sideTechModal');
    sideModal.style.display = 'none';
    document.getElementById('side-modal-tech-name').textContent = '';
    document.getElementById('side-modal-category').textContent = '';
    document.getElementById('side-modal-domains-list').innerHTML = '';

    // Destroy previous chart if exists to prevent stale data
    if (categoryChartInstance) {
      categoryChartInstance.destroy();
      categoryChartInstance = null;
    }

    // Clear table to prevent showing old data
    const tbody = document.getElementById('modal-cat-tech-body');
    tbody.innerHTML = '<tr><td colspan="2" class="loading-text" style="text-align:center;">Loading...</td></tr>';

    // Fetch technologies in this category with cache busting
    try {
      const res = await fetch(`/api/category/${encodeURIComponent(categoryName)}/technologies?t=${Date.now()}`);
      const data = await res.json();

      if (data.technologies && data.technologies.length > 0) {
        const techs = data.technologies; // Show all technologies, not just top 10
        const labels = techs.map(t => t.tech);
        const counts = techs.map(t => t.count);

        // Create horizontal bar chart
        const ctx = document.getElementById('categoryTechChart');
        categoryChartInstance = makeBarChart('categoryTechChart', labels, counts, '#60a5fa');

        // Populate table with fresh data
        tbody.innerHTML = '';
        techs.forEach(t => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="font-weight:600;">${t.tech}</td><td style="text-align:right;font-weight:600;">${t.count}</td>`;
          tr.addEventListener('click', () => openSideTechModal(t));
          tr.style.cursor = 'pointer';
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="2" class="loading-text" style="text-align:center;">No technologies found</td></tr>';
      }
    } catch (e) {
      console.error('Failed to load category data', e);
      tbody.innerHTML = '<tr><td colspan="2" class="loading-text" style="text-align:center;">Error loading data</td></tr>';
    }
  }

  function closeCategoryModal() {
    document.getElementById('categoryModal').classList.add('hidden');
    if (categoryChartInstance) {
      categoryChartInstance.destroy();
      categoryChartInstance = null;
    }
  }

  async function openSideTechModal(tech) {
    const sideModal = document.getElementById('sideTechModal');
    sideModal.style.display = 'block';

    document.getElementById('side-modal-tech-name').textContent = tech.tech;
    const categories = Array.isArray(tech.categories) ? tech.categories : normalizeCategories(tech.categories || tech.category);
    const category = categories.length ? categories.join(', ') : '-';
    document.getElementById('side-modal-category').textContent = 'Category: ' + category;

    // Clear previous data and show loading
    const domainsList = document.getElementById('side-modal-domains-list');
    domainsList.innerHTML = '<li class="loading-text" style="font-size:0.85rem;">Loading domains...</li>';

    try {
      // Fresh fetch with cache busting
      const res = await fetch(`/api/tech/${encodeURIComponent(tech.tech)}/domains?t=${Date.now()}`);
      const data = await res.json();

      if (data.domains && data.domains.length > 0) {
        domainsList.innerHTML = data.domains.map(d =>
          `<li style="padding:0.4rem;background:rgba(255,255,255,0.05);margin:0.25rem 0;border-radius:0.3rem;font-size:0.85rem;"><a href="https://${d}" target="_blank" style="color:#60a5fa;text-decoration:none;">${d}</a></li>`
        ).join('');
      } else {
        domainsList.innerHTML = '<li class="loading-text" style="font-size:0.85rem;">No domains found</li>';
      }
    } catch (e) {
      domainsList.innerHTML = '<li class="loading-text" style="font-size:0.85rem;">Failed to load domains</li>';
    }
  }

  function closeSideTechModal() {
    document.getElementById('sideTechModal').style.display = 'none';
  }

  const CATEGORY_SEGMENT_PALETTE = ['#22c55e', '#60a5fa', '#fbbf24', '#f472b6', '#a78bfa', '#fb923c', '#14b8a6', '#f43f5e', '#8b5cf6', '#06b6d4'];
  const CATEGORY_CARD_LIMIT = 30;

  function buildCategorySegments(techList, totalCount, displayLabel) {
    const fallbackLabel = displayLabel || 'Unknown';
    const normalized = Array.isArray(techList)
      ? techList
        .map(item => {
          const rawName = item && (item.name || item.tech || item.label);
          const name = rawName ? String(rawName).trim() : fallbackLabel;
          const count = Number(item && item.count);
          return { name, count: Number.isFinite(count) && count > 0 ? count : 0 };
        })
        .filter(item => item.count > 0)
      : [];

    const maxSegments = 6;
    const limited = normalized.slice(0, maxSegments);
    let usedTotal = limited.reduce((sum, item) => sum + item.count, 0);
    const budget = Number(totalCount);

    if (!limited.length && Number.isFinite(budget) && budget > 0) {
      return {
        segments: [{ name: fallbackLabel, count: budget }],
        total: budget
      };
    }

    const segments = limited.slice();
    if (Number.isFinite(budget) && budget > usedTotal) {
      segments.push({ name: 'Other', count: budget - usedTotal, isRemainder: true });
      usedTotal = budget;
    }

    if (!segments.length) {
      segments.push({ name: fallbackLabel, count: 1, isSynthetic: true });
      usedTotal = 1;
    }

    const total = segments.reduce((sum, item) => sum + (Number(item.count) || 0), 0) || usedTotal || 1;
    return { segments, total };
  }

  function renderCategoryTopTechList(container, segments) {
    if (!container) return;
    const meaningfulSegments = Array.isArray(segments)
      ? segments.filter(item => item && !item.isRemainder && !item.isSynthetic && (Number(item.count) || 0) > 0)
      : [];

    if (!meaningfulSegments.length) {
      container.innerHTML = '<div class="loading-text" style="margin-top:0.75rem;font-size:0.75rem;">No top technologies mapped yet</div>';
      return;
    }

    const listMarkup = `<ul style="list-style:none;padding:0;margin:0.75rem 0 0;width:100%;display:flex;flex-direction:column;gap:0.4rem;">${meaningfulSegments.map(seg => {
      const name = escapeHtml(seg.name || 'Unknown');
      const count = Number(seg.count) || 0;
      const countLabel = count ? count.toLocaleString('en-US') : '-';
      return `<li style="display:flex;justify-content:space-between;align-items:center;font-size:0.78rem;color:rgba(255,255,255,0.85);"><span style="font-weight:500;">${name}</span><span style="color:rgba(255,255,255,0.65);font-size:0.72rem;">${countLabel}</span></li>`;
    }).join('')}</ul>`;
    container.innerHTML = listMarkup;
  }

  function updateCategoryChart(chart, segmentBundle, palette, fallbackLabel) {
    if (!chart || !segmentBundle) return;
    const segments = Array.isArray(segmentBundle.segments) ? segmentBundle.segments : [];
    if (!segments.length) return;
    const total = Number(segmentBundle.total) || segments.reduce((sum, seg) => sum + (Number(seg.count) || 0), 0) || 1;
    const colors = segments.map((_, idx) => palette[idx % palette.length]);

    chart.data.datasets[0].data = segments.map(seg => {
      const value = Number(seg.count);
      return Number.isFinite(value) && value > 0 ? value : 1;
    });
    chart.data.datasets[0].backgroundColor = colors;
    chart.data.labels = segments.map(seg => {
      const labelBase = seg && seg.name ? seg.name : fallbackLabel;
      const value = Number(seg.count) || 0;
      const pct = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
      return value ? `${labelBase} (${value.toLocaleString('en-US')} Â· ${pct}%)` : labelBase;
    });
    chart.update();
  }

  async function hydrateCategoryCard(details) {
    const { categoryName, displayName, chart, listContainer, palette, totalCount, fallbackData, cardElement } = details;
    if (!categoryName || !chart) return;

    const hasMeaningfulFallback = fallbackData
      && Array.isArray(fallbackData.segments)
      && fallbackData.segments.some(item => item && !item.isRemainder && !item.isSynthetic && (Number(item.count) || 0) > 0);

    if (listContainer && !hasMeaningfulFallback) {
      listContainer.innerHTML = '<div class="loading-text" style="margin-top:0.75rem;font-size:0.75rem;">Loading breakdown...</div>';
    }

    try {
      const res = await fetch(`/api/category/${encodeURIComponent(categoryName)}/technologies?t=${Date.now()}`, { cache: 'no-store' });
      if (!res || !res.ok) {
        throw new Error(`category fetch failed status=${res ? res.status : 'n/a'}`);
      }
      const payload = await res.json();
      const techs = payload && Array.isArray(payload.technologies) ? payload.technologies : [];

      // For uncategorized category, recalculate total from filtered techs
      let effectiveTotalCount = totalCount;
      if (categoryName.toLowerCase() === 'uncategorized' && techs.length > 0) {
        effectiveTotalCount = techs.reduce((sum, t) => sum + (Number(t.count) || 0), 0);
        // Update the count display in the card
        if (cardElement) {
          const countEl = cardElement.querySelector('.category-usage-count');
          if (countEl) {
            countEl.textContent = effectiveTotalCount ? `${effectiveTotalCount.toLocaleString('en-US')} usages` : 'No usage data';
          }
        }
      }

      const segmentsData = buildCategorySegments(techs, effectiveTotalCount, displayName);
      if (!segmentsData.segments.length) {
        throw new Error('empty category segments');
      }
      updateCategoryChart(chart, segmentsData, palette, displayName);
      renderCategoryTopTechList(listContainer, segmentsData.segments);
    } catch (err) {
      console.warn('category breakdown fallback', categoryName, err);
      if (fallbackData) {
        updateCategoryChart(chart, fallbackData, palette, displayName);
        renderCategoryTopTechList(listContainer, fallbackData.segments);
      } else if (listContainer) {
        listContainer.innerHTML = '<div class="loading-text" style="margin-top:0.75rem;font-size:0.75rem;">No technologies found</div>';
      }
    }
  }

  function renderCategoryClassification(categories) {
    const container = document.getElementById('category-charts-container');

    Object.keys(categoryPieCharts).forEach(key => {
      if (categoryPieCharts[key]) {
        categoryPieCharts[key].destroy();
      }
    });
    categoryPieCharts = {};
    container.innerHTML = '';

    const usableCategories = Array.isArray(categories)
      ? categories.filter(cat => cat && (cat.category || cat.rawCategory))
      : [];
    const topCategories = CATEGORY_CARD_LIMIT > 0
      ? usableCategories.slice(0, CATEGORY_CARD_LIMIT)
      : usableCategories;
    if (!topCategories.length) {
      container.innerHTML = '<div class="loading-text" style="padding:1rem;">No category data available</div>';
      return;
    }

    topCategories.forEach((cat, idx) => {
      const displayName = cat && (cat.category || cat.rawCategory) ? escapeHtml(cat.category || cat.rawCategory) : 'Unknown';
      const rawName = cat && (cat.rawCategory || cat.category) ? String(cat.rawCategory || cat.category) : 'Unknown';
      const totalCount = Number(cat && cat.count) || 0;
      const usageText = totalCount ? `${totalCount.toLocaleString('en-US')} usages` : 'Usage data unavailable';
      const techEntries = Array.isArray(cat && cat.techs) ? cat.techs : [];
      const fallbackData = buildCategorySegments(techEntries, totalCount, displayName);

      const chartDiv = document.createElement('div');
      chartDiv.style.cssText = 'min-width:230px;max-width:230px;display:flex;flex-direction:column;align-items:center;cursor:pointer;background:rgba(255,255,255,0.08);padding:1rem;border-radius:0.8rem;transition:all 0.3s ease;scroll-snap-align:start;';
      chartDiv.classList.add('category-card');

      const cardMarkup = `
      <h4 style="font-size:0.95rem;font-weight:600;margin-bottom:0.8rem;text-align:center;min-height:2.5rem;display:flex;align-items:center;justify-content:center;">${displayName}</h4>
      <div style="position:relative;height:160px;width:160px;">
        <canvas id="cat-pie-${idx}"></canvas>
      </div>
      <div class="category-usage-count">${usageText}</div>
      <div data-role="category-tech-list" style="width:100%;"></div>
    `;

      chartDiv.innerHTML = cardMarkup;
      chartDiv.addEventListener('click', () => openCategoryModal(rawName));
      container.appendChild(chartDiv);

      const listContainer = chartDiv.querySelector('[data-role="category-tech-list"]');
      renderCategoryTopTechList(listContainer, fallbackData.segments);

      setTimeout(() => {
        const canvasId = `cat-pie-${idx}`;
        const ctx = document.getElementById(canvasId);
        if (!ctx || !ensureChartLib()) return;

        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: [],
            datasets: [{
              data: [],
              backgroundColor: [],
              borderWidth: 3,
              borderColor: 'rgba(255,255,255,0.1)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.9)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderWidth: 1,
                padding: 10,
                borderColor: function (context) {
                  const colors = context && context.chart && context.chart.data && context.chart.data.datasets && context.chart.data.datasets[0] && context.chart.data.datasets[0].backgroundColor;
                  const index = context && typeof context.dataIndex === 'number' ? context.dataIndex : 0;
                  return Array.isArray(colors) ? (colors[index] || '#60a5fa') : '#60a5fa';
                },
                callbacks: {
                  label: function (context) {
                    const datasetValues = context && context.dataset && Array.isArray(context.dataset.data)
                      ? context.dataset.data
                      : [];
                    const total = datasetValues.reduce((a, b) => a + b, 0) || 1;
                    const value = Number(context && context.parsed) || 0;
                    const percentage = ((value / total) * 100).toFixed(1);
                    const hoverLabel = context && typeof context.label === 'string' ? context.label : 'Value';
                    return `${hoverLabel}: ${value.toLocaleString('en-US')} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        categoryPieCharts[canvasId] = chart;
        updateCategoryChart(chart, fallbackData, CATEGORY_SEGMENT_PALETTE, displayName);
        hydrateCategoryCard({
          categoryName: rawName,
          displayName,
          chart,
          listContainer,
          palette: CATEGORY_SEGMENT_PALETTE,
          totalCount,
          fallbackData,
          cardElement: chartDiv
        });
      }, 50);
    });
  }

  function scrollCarousel(direction) {
    const container = document.querySelector('.carousel-container');
    const scrollAmount = 250; // width of one card + gap
    container.scrollLeft += direction * scrollAmount;
  }

  const modalDomainSearch = document.getElementById('modal-domain-search');
  if (modalDomainSearch) {
    modalDomainSearch.addEventListener('input', () => filterTechModalDomains(modalDomainSearch.value || ''));
  }
  const copyTechBtnRef = document.getElementById('copy-tech-btn');
  if (copyTechBtnRef) {
    copyTechBtnRef.addEventListener('click', copyTechName);
  }

  fetchStats();

  // Auto-refresh controlled by server-side env variable TECHSCAN_STATS_AUTO_REFRESH
  // Default: manual (off). If enabled via env, interval is 5 minutes (300000ms)
  const autoRefreshEnabled = {{ config.get('STATS_AUTO_REFRESH', 'false') | lower }};
  const autoRefreshInterval = {{ config.get('STATS_AUTO_REFRESH_INTERVAL_MS', '300000') | int }};
  let statsRefreshTimer = null;

  if (autoRefreshEnabled) {
    statsRefreshTimer = setInterval(fetchStats, autoRefreshInterval);
    console.log('[stats] Auto-refresh enabled, interval:', autoRefreshInterval, 'ms');
  } else {
    console.log('[stats] Auto-refresh disabled. Use Ctrl+F5 or refresh button to update.');
  }

  // Cleanup saat page unload (optional, good practice)
  window.addEventListener('beforeunload', () => {
    if (uptimeInterval) clearInterval(uptimeInterval);
    if (statsRefreshTimer) clearInterval(statsRefreshTimer);
  });

  // Enable horizontal scroll with mouse wheel on carousel
  document.addEventListener('DOMContentLoaded', function () {
    const carousel = document.getElementById('carousel-container');
    if (carousel) {
      carousel.addEventListener('wheel', function (e) {
        if (e.deltaY !== 0) {
          e.preventDefault();
          carousel.scrollLeft += e.deltaY;
        }
      }, { passive: false });
    }
  });
</script>

<style>
  /* Table theme variables */
  :root {
    --ts-table-header-bg-dark: rgba(15, 23, 42, 0.9);
  }

  .payload-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
  }

  .payload-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
  }

  .payload-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 32px -18px rgba(15, 23, 42, 0.65);
    border-color: rgba(255, 255, 255, 0.22);
  }

  .payload-label {
    font-size: 0.65rem;
    letter-spacing: 0.4px;
    text-transform: uppercase;
    opacity: 0.75;
    margin-bottom: 0.35rem;
  }

  .payload-value {
    font-size: 1.45rem;
    font-weight: 600;
    letter-spacing: 0.35px;
  }

  .tech-modal-panel {
    width: min(720px, calc(100vw - 2rem));
    max-height: 80vh;
    overflow: hidden;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(13, 148, 136, 0.4));
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 24px;
    padding: 1.5rem;
    box-shadow: 0 30px 60px -25px rgba(0, 8, 20, 0.85);
    color: #f8fafc;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .tech-modal-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .tech-modal-label {
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0.65;
    margin-bottom: 0.25rem;
  }

  .tech-modal-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tech-modal-actions .ghost.icon {
    width: 38px;
    height: 38px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.15rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tech-modal-actions .ghost.icon:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  .tech-modal-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1.25rem;
  }

  .metric-card {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 18px;
    padding: 0.85rem 1rem;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
  }

  .metric-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.65;
    margin-bottom: 0.25rem;
    display: block;
  }

  .metric-value {
    font-size: 1.35rem;
    font-weight: 700;
    line-height: 1.2;
    display: block;
  }

  .tech-modal-body {
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 18px;
    padding: 1rem;
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }

  .tech-modal-body-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .tech-modal-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  #modal-domain-search {
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
    padding: 0.4rem 0.65rem;
    border-radius: 999px;
    font-size: 0.75rem;
    min-width: 200px;
  }

  #modal-domain-search::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }

  .domain-chip-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.5rem;
    overflow: auto;
    flex: 1;
  }

  .domain-chip-list li {
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    font-size: 0.8rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .domain-chip-list li a {
    color: #93c5fd;
    text-decoration: none;
    font-weight: 600;
  }

  .domain-chip-list li a:hover {
    text-decoration: underline;
  }

  body.light .tech-modal-panel {
    background: rgba(255, 255, 255, 0.98);
    color: #0f172a;
    border-color: rgba(15, 23, 42, 0.08);
  }

  body.light .tech-modal-actions .ghost.icon {
    background: rgba(15, 23, 42, 0.08);
    border-color: rgba(15, 23, 42, 0.2);
    color: #0f172a;
  }

  body.light .metric-card {
    background: rgba(15, 23, 42, 0.04);
    border-color: rgba(15, 23, 42, 0.08);
  }

  body.light #modal-domain-search {
    background: #fff;
    color: #0f172a;
    border-color: rgba(15, 23, 42, 0.15);
  }

  body.light .domain-chip-list li {
    background: rgba(15, 23, 42, 0.04);
    border-color: rgba(15, 23, 42, 0.08);
  }

  @media (max-width:600px) {
    .tech-modal-panel {
      padding: 1.1rem;
      border-radius: 18px;
    }

    .tech-modal-actions {
      width: 100%;
      justify-content: flex-start;
    }

    #modal-domain-search {
      min-width: 0;
      flex: 1;
    }
  }

  body.light .payload-card {
    background: rgba(255, 255, 255, 0.92);
    border-color: rgba(15, 23, 42, 0.08);
    box-shadow: 0 12px 26px -20px rgba(15, 23, 42, 0.25);
  }

  body.light .payload-label {
    color: #1f2937;
    opacity: 0.7;
  }

  body.light .payload-value {
    color: #0f172a;
  }

  /* =============================================================
   SMOOTH ANIMATIONS FOR STATS DASHBOARD
   ============================================================= */
  /* Glass card fade-in animation on page load */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .glass-card {
    animation: fadeInUp 0.6s ease-out backwards;
  }

  /* Stagger animation for multiple cards */
  .dashboard-wrapper .glass-card:nth-child(1) {
    animation-delay: 0.1s;
  }

  .dashboard-wrapper .glass-card:nth-child(2) {
    animation-delay: 0.2s;
  }

  .dashboard-wrapper .glass-card:nth-child(3) {
    animation-delay: 0.3s;
  }

  .dashboard-wrapper .glass-card:nth-child(4) {
    animation-delay: 0.4s;
  }

  .dashboard-wrapper .glass-card:nth-child(5) {
    animation-delay: 0.5s;
  }

  /* Mini cards hover effect */
  .mini-card {
    transition: transform 0.3s cubic-bezier(0.22, 0.72, 0.18, 0.99),
      box-shadow 0.3s ease,
      background-color 0.3s ease;
  }

  .mini-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
    background: rgba(255, 255, 255, 0.2);
  }

  /* Chart container hover lift */
  .chart-container {
    transition: transform 0.3s cubic-bezier(0.22, 0.72, 0.18, 0.99),
      box-shadow 0.3s ease;
  }

  .chart-container:hover {
    transform: translateY(-2px);
  }

  /* Category card hover animation */
  .category-card {
    transition: transform 0.35s cubic-bezier(0.22, 0.72, 0.18, 0.99),
      box-shadow 0.35s ease,
      border-color 0.25s ease,
      background-color 0.25s ease;
    cursor: pointer;
  }

  .category-card:hover {
    transform: translateY(-6px) scale(1.03);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
    border-color: rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.12);
  }

  .category-card:active {
    transform: translateY(-3px) scale(1.01);
  }

  /* Modal smooth fade-in animation */
  @keyframes modalFadeIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(-20px);
    }

    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .modal {
    animation: modalFadeIn 0.3s cubic-bezier(0.22, 0.72, 0.18, 0.99);
  }

  .modal-content {
    animation: modalFadeIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* Modal close button smooth transitions */
  .modal-close-btn,
  .modal-close-btn-small {
    transition: background-color 0.25s ease,
      transform 0.2s ease,
      box-shadow 0.25s ease;
  }

  .modal-close-btn:hover,
  .modal-close-btn-small:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .modal-close-btn:active,
  .modal-close-btn-small:active {
    transform: scale(0.98);
  }

  /* Carousel smooth scrolling */
  .carousel-container {
    scroll-behavior: smooth;
  }

  /* Carousel item fade-in animation */
  @keyframes carouselItemFadeIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }

    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .carousel-track>* {
    animation: carouselItemFadeIn 0.4s ease-out backwards;
  }

  /* Stagger carousel items */
  .carousel-track>*:nth-child(1) {
    animation-delay: 0.1s;
  }

  .carousel-track>*:nth-child(2) {
    animation-delay: 0.15s;
  }

  .carousel-track>*:nth-child(3) {
    animation-delay: 0.2s;
  }

  .carousel-track>*:nth-child(4) {
    animation-delay: 0.25s;
  }

  .carousel-track>*:nth-child(5) {
    animation-delay: 0.3s;
  }

  .carousel-track>*:nth-child(6) {
    animation-delay: 0.35s;
  }

  /* Table row smooth hover */
  .tech-table tbody tr {
    transition: background-color 0.25s ease,
      transform 0.2s ease,
      box-shadow 0.3s ease;
  }

  .tech-table tbody tr:hover {
    transform: translateX(4px);
    box-shadow: -4px 0 0 rgba(96, 165, 250, 0.5);
  }

  /* Health tag pulse animation */
  @keyframes healthPulse {

    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }

    50% {
      opacity: 0.8;
      transform: scale(1.05);
    }
  }

  .health-tag {
    transition: color 0.3s ease, transform 0.2s ease;
  }

  /* Confidence value animate in */
  @keyframes confidenceScaleIn {
    from {
      opacity: 0;
      transform: scale(0.5);
    }

    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  #confidence-value {
    animation: confidenceScaleIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    transition: color 0.3s ease, transform 0.3s ease;
  }

  #confidence-value:hover {
    transform: scale(1.1);
  }

  /* Chart canvas fade-in */
  canvas {
    animation: fadeInUp 0.5s ease-out;
  }

  /* Hero title gradient animation */
  @keyframes gradientShift {
    0% {
      background-position: 0% 50%;
    }

    50% {
      background-position: 100% 50%;
    }

    100% {
      background-position: 0% 50%;
    }
  }

  .hero-title {
    background-size: 200% auto;
    animation: gradientShift 3s ease infinite;
  }

  /* Smooth scrollbar appearance */
  .carousel-container::-webkit-scrollbar-thumb {
    transition: background 0.25s ease;
  }

  /* Dark mode defaults for stats widgets */
  .mini-card {
    background: rgba(255, 255, 255, 0.15);
    padding: .8rem;
    border-radius: .5rem;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .mini-label {
    font-size: .7rem;
    opacity: .9;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: rgba(255, 255, 255, 0.85);
  }

  .mini-value {
    font-size: 1.4rem;
    font-weight: 700;
    margin-top: .3rem;
    color: #fff;
  }

  .mini-value-small {
    font-size: 0.85rem;
    font-weight: 600;
    line-height: 1.2;
    margin-top: .3rem;
    word-break: break-word;
    color: #fff;
  }

  .health-tag {
    font-size: .8rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
  }

  .chart-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .chart-title {
    font-size: .85rem;
    font-weight: 600;
    margin-bottom: .5rem;
    opacity: .95;
    text-align: center;
    color: rgba(255, 255, 255, 0.9);
  }

  .tech-table {
    color: rgba(255, 255, 255, 0.95);
    border-collapse: separate;
    border-spacing: 0;
  }

  .tech-table thead th {
    position: sticky;
    top: 0;
    background: var(--ts-table-header-bg-dark, rgba(15, 23, 42, 0.9));
    z-index: 5;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    padding: 0.8rem 0.5rem;
    color: rgba(255, 255, 255, 0.85);
    font-size: 0.68rem;
  }

  .tech-table tbody td {
    padding: 0.8rem 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.95);
    font-size: 0.7rem;
  }

  .tech-table tbody tr {
    color: rgba(255, 255, 255, 0.95);
    background: rgba(15, 23, 42, 0.5);
  }

  .tech-table tbody tr:nth-child(even) {
    background: rgba(15, 23, 42, 0.65);
  }

  .tech-table tr:hover {
    background: rgba(255, 255, 255, 0.06);
    cursor: pointer;
  }

  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    padding: 1.5rem;
    border-radius: 1rem;
    background: rgba(30, 30, 40, 0.95);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    color: #fff;
  }

  .modal-content h3,
  .modal-content h4 {
    color: #fff;
  }

  .modal-content p {
    color: rgba(255, 255, 255, 0.8);
  }

  .modal-content li {
    color: rgba(255, 255, 255, 0.9);
  }

  .category-card {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
  }

  .category-card h4 {
    color: rgba(255, 255, 255, 0.95);
  }

  .carousel-container::-webkit-scrollbar {
    height: 8px;
  }

  .carousel-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
  }

  .carousel-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
  }

  .carousel-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .modal-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    color: #fff;
  }

  .modal-close-btn-small {
    background: rgba(255, 255, 255, 0.15);
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 0.4rem;
    cursor: pointer;
    color: #fff;
    font-size: 0.85rem;
  }

  .modal-subtitle {
    margin: 0.3rem 0 0 0;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .modal-subtitle-small {
    margin: 0.3rem 0 0 0;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .table-index {
    opacity: 0.6;
    color: rgba(255, 255, 255, 0.6);
  }

  .table-category {
    opacity: 0.8;
    color: rgba(255, 255, 255, 0.8);
  }

  .confidence-label {
    font-size: 0.9rem;
    opacity: 0.7;
    margin-top: 0.5rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .category-usage-count {
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: 0.8rem;
    color: #60a5fa;
  }

  .loading-text {
    opacity: 0.6;
    color: rgba(255, 255, 255, 0.6);
  }

  .hero-lead {
    opacity: 0.9;
    color: rgba(255, 255, 255, 0.9);
  }

  /* Light mode overrides */
  @media (prefers-color-scheme: light) {
    body {
      background: #f5f5f5;
    }

    .mini-card {
      background: rgba(248, 248, 248, 1);
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .mini-card:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .mini-label {
      color: #333 !important;
    }

    .mini-value {
      color: #000 !important;
    }

    .mini-value-small {
      color: #000 !important;
    }

    .health-tag {
      color: #000 !important;
    }

    .chart-title {
      color: #000 !important;
    }

    .tech-table {
      color: #000 !important;
    }

    .tech-table thead th {
      border-bottom: 2px solid rgba(0, 0, 0, 0.25);
      color: #374151 !important;
      font-weight: 700;
      background: rgba(249, 250, 251, 0.95);
    }

    .tech-table tbody td {
      border-bottom: 1px solid rgba(0, 0, 0, 0.15);
      color: #111 !important;
    }

    .tech-table tbody tr {
      color: #111 !important;
      background: #ffffff;
    }

    .tech-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .tech-table tr:hover {
      background: #f1f5f9;
      box-shadow: -4px 0 0 rgba(37, 99, 235, 0.5);
    }

    .modal {
      background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid rgba(0, 0, 0, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      color: #000 !important;
    }

    .modal-content h3,
    .modal-content h4 {
      color: #000 !important;
    }

    .modal-content p {
      color: #333 !important;
    }

    .modal-content li {
      color: #111 !important;
    }

    .category-card {
      background: rgba(248, 248, 248, 1) !important;
      border: 1px solid rgba(0, 0, 0, 0.2) !important;
    }

    .category-card h4 {
      color: #000 !important;
    }

    .category-card:hover {
      background: rgba(255, 255, 255, 1) !important;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25) !important;
    }

    .carousel-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    .carousel-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.3);
    }

    .carousel-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.4);
    }

    .modal-close-btn {
      background: rgba(0, 0, 0, 0.15);
      color: #000 !important;
    }

    .modal-close-btn:hover {
      background: rgba(0, 0, 0, 0.25);
    }

    .modal-close-btn-small {
      background: rgba(0, 0, 0, 0.1);
      color: #000 !important;
    }

    .modal-close-btn-small:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .modal-subtitle {
      color: #555 !important;
    }

    .modal-subtitle-small {
      color: #555 !important;
    }

    .table-index {
      opacity: 1;
      color: #666 !important;
    }

    .table-category {
      opacity: 1;
      color: #444 !important;
    }

    .confidence-label {
      opacity: 1;
      color: #666 !important;
    }

    .category-usage-count {
      color: #2563eb !important;
    }

    .loading-text {
      opacity: 1;
      color: #666 !important;
    }

    .hero-lead {
      opacity: 1;
      color: #333 !important;
    }
  }

  /* Explicit dark mode class support */
  .dark .mini-card {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .dark .mini-card:hover {
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
  }

  .dark .mini-label,
  .dark .chart-title {
    color: rgba(255, 255, 255, 0.85);
  }

  .dark .mini-value,
  .dark .mini-value-small {
    color: #fff;
  }

  .dark .health-tag {
    color: rgba(255, 255, 255, 0.9);
  }

  .dark .tech-table {
    color: rgba(255, 255, 255, 0.95);
  }

  .dark .tech-table thead th {
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.85);
  }

  .dark .tech-table tbody tr:hover {
    box-shadow: -4px 0 0 rgba(96, 165, 250, 0.5);
  }

  .dark .category-card:hover {
    background: rgba(255, 255, 255, 0.12) !important;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35) !important;
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {

    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }

    .carousel-container {
      scroll-behavior: auto;
    }
  }

  .dark .tech-table tbody td {
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.95);
  }

  .dark .tech-table tr:hover {
    background: rgba(255, 255, 255, 0.12);
  }

  .dark .modal-content {
    background: rgba(30, 30, 40, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
  }

  .dark .modal-content h3,
  .dark .modal-content h4 {
    color: #fff;
  }

  /* Explicit light mode class support */
  body.light {
    background: #f5f5f5;
  }

  body.light .mini-card {
    background: rgba(248, 248, 248, 1);
    border: 1px solid rgba(0, 0, 0, 0.2);
  }

  body.light .mini-label,
  body.light .chart-title {
    color: #333 !important;
  }

  body.light .mini-value,
  body.light .mini-value-small {
    color: #000 !important;
  }

  body.light .health-tag {
    color: #000 !important;
  }

  body.light .tech-table {
    color: #000 !important;
  }

  body.light .tech-table thead th {
    border-bottom: 2px solid rgba(0, 0, 0, 0.25);
    color: #374151 !important;
    font-weight: 700;
    background: rgba(249, 250, 251, 0.95);
  }

  body.light .tech-table tbody td {
    border-bottom: 1px solid rgba(0, 0, 0, 0.15);
    color: #111 !important;
  }

  body.light .tech-table tbody tr {
    color: #111 !important;
    background: #ffffff;
  }

  body.light .tech-table tbody tr:nth-child(even) {
    background: #f9fafb;
  }

  body.light .tech-table tr:hover {
    background: #f1f5f9;
  }

  body.light .modal-content {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid rgba(0, 0, 0, 0.25);
    color: #000 !important;
  }

  body.light .modal-content h3,
  body.light .modal-content h4 {
    color: #000 !important;
  }

  body.light .modal-content p {
    color: #333 !important;
  }

  body.light .modal-content li {
    color: #111 !important;
  }

  body.light .category-card {
    background: rgba(248, 248, 248, 1) !important;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
  }

  body.light .category-card h4 {
    color: #000 !important;
  }

  body.light .category-card:hover {
    background: rgba(255, 255, 255, 1) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
  }

  body.light .modal-close-btn {
    background: rgba(0, 0, 0, 0.15);
    color: #000 !important;
  }

  body.light .modal-close-btn-small {
    background: rgba(0, 0, 0, 0.1);
    color: #000 !important;
  }

  body.light .modal-subtitle {
    color: #555 !important;
  }

  body.light .modal-subtitle-small {
    color: #555 !important;
  }

  body.light .table-index {
    opacity: 1;
    color: #666 !important;
  }

  body.light .table-category {
    opacity: 1;
    color: #444 !important;
  }

  body.light .confidence-label {
    opacity: 1;
    color: #666 !important;
  }

  body.light .category-usage-count {
    color: #2563eb !important;
  }

  body.light .loading-text {
    opacity: 1;
    color: #666 !important;
  }

  body.light .hero-lead {
    opacity: 1;
    color: #333 !important;
  }
</style>
{% endblock %}