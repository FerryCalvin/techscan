{% extends 'base.html' %}
{% block content %}
<style>
  /* Spacing between controls and results */
  .tech-shell {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .tech-controls-card {
    margin-bottom: 1rem;
  }

  .tech-results-card {
    margin-top: 1rem;
  }

  /* Table styling like websites */
  :root {
    --ts-table-header-bg-dark: rgba(15, 23, 42, 0.9);
  }

  #ts-table thead th {
    position: sticky;
    top: 0;
    background: var(--ts-table-header-bg-dark);
    z-index: 5;
    font-size: 0.68rem;
    transition: all 0.25s ease;
  }

  #ts-table thead th.sortable {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.25s ease;
  }

  #ts-table thead th.sortable:hover {
    background: rgba(255, 255, 255, 0.08);
  }

  #ts-table thead th.sortable:after {
    content: '\25B4';
    opacity: 0;
    font-size: .55rem;
    margin-left: 4px;
    transition: opacity 0.25s ease, transform 0.25s ease;
  }

  #ts-table thead th.sortable.sorted-asc:after {
    content: '\25B4';
    opacity: .85;
    transform: translateY(-1px);
  }

  #ts-table thead th.sortable.sorted-desc:after {
    content: '\25BE';
    opacity: .85;
    transform: translateY(1px);
  }

  #ts-table tbody tr {
    transition: all 0.25s ease;
  }

  #ts-table tbody tr:hover {
    transform: translateX(4px);
    box-shadow: -4px 0 0 rgba(96, 165, 250, 0.5);
    background: rgba(255, 255, 255, 0.08);
  }

  .table-shadow {
    box-shadow: 0 6px 8px -6px rgba(0, 0, 0, .55);
  }

  /* Pagination styling */
  #paging-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: .9rem;
    font-size: 0.6rem;
  }

  .pg-box {
    display: flex;
    align-items: center;
    gap: .5rem;
    background: var(--ts-input-bg);
    border: 1px solid var(--ts-input-border);
    padding: 6px 10px;
    border-radius: 10px;
    height: 38px;
    transition: all 0.25s ease;
  }

  .pg-box select {
    background: var(--ts-input-bg);
    border: 1px solid var(--ts-input-border);
    color: var(--ts-text);
    font-size: 0.6rem;
    padding: 3px 6px;
    border-radius: 6px;
    height: 26px;
    line-height: 1;
    transition: all 0.2s ease;
  }

  .pg-nav {
    display: flex;
    align-items: center;
    gap: .4rem;
  }

  .pg-btn {
    font-size: .55rem;
    padding: 3px 10px;
    min-width: 36px;
    height: 26px;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s cubic-bezier(0.22, 0.72, 0.18, 0.99);
  }

  .pg-info {
    min-width: 120px;
    text-align: center;
    font-size: 0.6rem;
  }

  .pg-btn[disabled] {
    opacity: .4;
    cursor: not-allowed;
  }

  .pg-btn:not([disabled]) {
    border-color: var(--glass-border-strong);
  }

  .pg-btn:not([disabled]):hover {
    background: rgba(255, 255, 255, 0.06);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }

  tbody.page-fade {
    animation: pageFade .35s cubic-bezier(0.22, 0.72, 0.18, 0.99);
  }

  @keyframes pageFade {
    from {
      opacity: 0;
      transform: translateY(8px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Aesthetic scrollbar */
  .table-shadow::-webkit-scrollbar,
  #ts-suggest::-webkit-scrollbar,
  #cat-suggest::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .table-shadow::-webkit-scrollbar-thumb,
  #ts-suggest::-webkit-scrollbar-thumb,
  #cat-suggest::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.35);
    border-radius: 999px;
  }

  .table-shadow::-webkit-scrollbar-track,
  #ts-suggest::-webkit-scrollbar-track,
  #cat-suggest::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.25);
    border-radius: 999px;
  }

  /* Light mode overrides */
  body.light #ts-table thead th {
    background: rgba(248, 250, 252, 0.95) !important;
    color: #334155;
  }

  body.light #ts-table thead th.sortable:hover {
    background: rgba(0, 0, 0, 0.04) !important;
  }

  body.light #ts-table tbody tr:hover {
    background: rgba(59, 130, 246, 0.06);
    box-shadow: -4px 0 0 rgba(59, 130, 246, 0.4);
  }

  body.light .pg-box {
    background: #ffffff;
    border-color: #e2e8f0;
  }

  body.light .pg-box select {
    background: #ffffff;
    border-color: #d1d5db;
    color: #1e293b;
  }

  body.light .pg-btn:not([disabled]):hover {
    background: rgba(0, 0, 0, 0.04);
  }

  body.light .table-shadow::-webkit-scrollbar-thumb,
  body.light #ts-suggest::-webkit-scrollbar-thumb,
  body.light #cat-suggest::-webkit-scrollbar-thumb {
    background: rgba(100, 116, 139, 0.35);
  }

  body.light .table-shadow::-webkit-scrollbar-track,
  body.light #ts-suggest::-webkit-scrollbar-track,
  body.light #cat-suggest::-webkit-scrollbar-track {
    background: rgba(241, 245, 249, 0.5);
  }
</style>
<div class="page-wrapper tech-shell">
  <div class="page-centered glass-card tech-controls-card">
    <h2 class="page-title">Technology Search</h2>
    <form id="tech-form" class="controls-row" autocomplete="off">
      <div class="search-col search-col--primary" style="position:relative;">
        <label for="ts-tech">Technology</label>
        <input id="ts-tech" name="tech" type="text" placeholder="WordPress" autocomplete="off" />
        <div id="ts-suggest"
          style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--glass-surf-2);border:1px solid var(--glass-border-strong);border-radius:12px;margin-top:4px;z-index:40;max-height:240px;overflow:auto;box-shadow:var(--glass-shadow-1), var(--glass-shadow-2);backdrop-filter:blur(calc(var(--glass-blur)*.55)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(calc(var(--glass-blur)*.55)) saturate(var(--glass-sat));font-size:.6rem;">
          <div class="sg-status" style="display:none;padding:8px 10px;opacity:.7;">Loading...</div>
          <div class="sg-items"></div>
        </div>
      </div>
      <div class="search-col search-col--compact" style="position:relative;">
        <label for="ts-category">Category</label>
        <input id="ts-category" name="category" type="text" placeholder="cms" autocomplete="off" />
        <div id="cat-suggest"
          style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--glass-surf-2);border:1px solid var(--glass-border-strong);border-radius:12px;margin-top:4px;z-index:40;max-height:220px;overflow:auto;box-shadow:var(--glass-shadow-1), var(--glass-shadow-2);backdrop-filter:blur(calc(var(--glass-blur)*.55)) saturate(var(--glass-sat));-webkit-backdrop-filter:blur(calc(var(--glass-blur)*.55)) saturate(var(--glass-sat));font-size:.6rem;">
          <div class="cat-status" style="display:none;padding:6px 8px;opacity:.7;">Loading...</div>
          <div class="cat-items"></div>
        </div>
      </div>
      <div class="search-col search-col--compact">
        <label for="ts-version">Version</label>
        <input id="ts-version" name="version" type="text" placeholder="6.5.3" />
      </div>
      <div class="right-col">
        <button id="ts-submit" class="secondary" type="submit" aria-label="Search" title="Search">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="7"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </div>
    </form>
    <div class="summary-line">
      <small id="ts-summary" class="mono">Enter a query and press Search.</small>
    </div>
  </div>
  <div class="page-centered glass-card tech-results-card" id="ts-results-wrap">
    <div class="table-shadow" style="overflow:auto;max-height:60vh;">
      <div class="table-loading" id="ts-loading">Loading...</div>
      <table id="ts-table" class="table-glass table-glass--compact">
        <thead>
          <tr>
            <th style="width:34px;">#</th>
            <th class="sortable" data-sort="domain">Domain</th>
            <th class="sortable" data-sort="tech_name">Technology</th>
            <th>Version</th>
            <th>Category</th>
            <th class="sortable" data-sort="first_seen">First Seen</th>
            <th class="sortable" data-sort="last_seen">Last Seen</th>
          </tr>
        </thead>
        <tbody id="ts-tbody">
          <tr>
            <td colspan="7" id="ts-empty">
              <div class="ts-empty-panel">
                <div class="ts-empty-title">Nothing to show yet</div>
                <div class="ts-empty-hint">Use the filters above, then hit Search.</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="paging-bar" class="small" style="display:none;">
      <div class="pg-box">
        <label for="page-size" style="margin:0;opacity:.75;">Show</label>
        <select id="page-size">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="pg-box pg-nav">
        <button id="page-first" class="secondary outline pg-btn" disabled>&laquo;</button>
        <button id="page-prev" class="secondary outline pg-btn" disabled>&lt;</button>
        <span id="page-info" class="pg-info">Page 1/1</span>
        <button id="page-next" class="secondary outline pg-btn" disabled>&gt;</button>
        <button id="page-last" class="secondary outline pg-btn" disabled>&raquo;</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('tech-form');
    const tbody = document.getElementById('ts-tbody');
    const summary = document.getElementById('ts-summary');
    const loading = document.getElementById('ts-loading');
    const pagingBar = document.getElementById('paging-bar');
    const pageInfo = document.getElementById('page-info');
    const pageSizeSel = document.getElementById('page-size');
    const btnFirst = document.getElementById('page-first');
    const btnPrev = document.getElementById('page-prev');
    const btnNext = document.getElementById('page-next');
    const btnLast = document.getElementById('page-last');

    const DEFAULT_PAGE_SIZE = parseInt(pageSizeSel?.value || '20', 10) || 20;
    const DEFAULT_SORT_KEY = 'last_seen';
    const DEFAULT_SORT_DIR = 'desc';

    if (!form) { console.error('[TechSearch] form #tech-form tidak ditemukan'); return; }

    // Diagnostics / fallback apiFetch
    if (typeof window.apiFetch !== 'function') {
      console.warn('[TechSearch] apiFetch tidak ditemukan; memakai fallback fetch');
      window.apiFetch = async (url, opts = {}) => {
        const r = await fetch(url, opts); if (!r.ok) throw new Error('HTTP ' + r.status); return r.json();
      };
    }

    let currentPage = 1;
    let pageSize = DEFAULT_PAGE_SIZE;
    let totalRows = 0;
    let sortKey = DEFAULT_SORT_KEY;
    let sortDir = DEFAULT_SORT_DIR;
    let isDefaultView = true;

    const HTML_ESCAPE_MAP = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' };
    function escapeHTML(val) {
      if (val === undefined || val === null) return '';
      return String(val).replace(/[&<>"']/g, ch => HTML_ESCAPE_MAP[ch] || ch);
    }
    function highlightWithTerm(source, term) {
      const original = source == null ? '' : String(source);
      const lowerTerm = (term || '').toLowerCase();
      if (!lowerTerm) {
        return escapeHTML(original);
      }
      const lowerSource = original.toLowerCase();
      const hit = lowerSource.indexOf(lowerTerm);
      if (hit === -1) {
        return escapeHTML(original);
      }
      const before = original.slice(0, hit);
      const match = original.slice(hit, hit + term.length);
      const after = original.slice(hit + term.length);
      return `${escapeHTML(before)}<strong>${escapeHTML(match)}</strong>${escapeHTML(after)}`;
    }

    function fmtTime(ts) {
      if (!ts) return '';
      try { const d = new Date(ts * 1000); return d.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' }) + ' ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }); } catch (_) { return '' }
    }

    function buildParams(extra = {}) {
      const fd = new FormData(form);
      const params = new URLSearchParams();
      const tech = (fd.get('tech') || '').trim();
      const category = (fd.get('category') || '').trim();
      const version = (fd.get('version') || '').trim();
      if (tech) params.set('tech', tech);
      if (category) params.set('category', category);
      if (version) params.set('version', version);
      params.set('limit', pageSize);
      params.set('offset', (currentPage - 1) * pageSize);
      if (sortKey) params.set('sort', sortKey);
      if (sortDir) params.set('dir', sortDir);
      Object.entries(extra).forEach(([k, v]) => { if (v !== undefined && v !== null) params.set(k, v); });
      return params;
    }

    function hasActiveFilters() {
      const fd = new FormData(form);
      return ['tech', 'category', 'version'].some(name => ((fd.get(name) || '').trim().length > 0));
    }

    function shouldUseDefaultView() {
      return !hasActiveFilters() && currentPage === 1 && sortKey === DEFAULT_SORT_KEY && sortDir === DEFAULT_SORT_DIR;
    }

    function isDefaultQueryState() {
      return !hasActiveFilters() && currentPage === 1 && pageSize === DEFAULT_PAGE_SIZE && sortKey === DEFAULT_SORT_KEY && sortDir === DEFAULT_SORT_DIR;
    }

    async function runSearch(options = {}) {
      const skipPersist = options.skipPersist === true;
      const forceDefault = options.forceDefault === true;
      isDefaultView = forceDefault ? true : shouldUseDefaultView();
      const loadingLabel = isDefaultView ? 'Loading latest technologies...' : 'Searching...';
      loading.style.display = 'flex';
      tbody.innerHTML = `<tr><td colspan="7" id="ts-empty">${loadingLabel}</td></tr>`;
      summary.textContent = loadingLabel;
      summary.dataset.mode = isDefaultView ? 'default' : '';
      const t0 = performance.now();
      try {
        const params = buildParams();
        const data = await apiFetch('/search?' + params.toString());
        totalRows = data.total || 0;
        const renderedCount = renderResults(data.results || [], data.offset || 0);
        updateSummary(renderedCount);
        updatePaging();
        if (skipPersist) {
          if (isDefaultQueryState()) {
            window.history.replaceState(null, '', window.location.pathname);
          }
        } else {
          persistQueryToURL();
        }
        console.info('[TechSearch] Search OK', { duration_ms: +(performance.now() - t0).toFixed(1), total: totalRows });
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="7" class="small" style="color:#d66;">Error: ${e.message}</td></tr>`;
        pagingBar.style.display = 'none';
        console.error('[TechSearch] Search failed', e);
      } finally {
        loading.style.display = 'none';
        // Close suggestions after search completes
        try { hideSuggest(); } catch (_) { }
      }
    }

    function renderResults(rows, offset) {
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="7" id="ts-empty"><div style='padding:.9rem 0;display:flex;flex-direction:column;align-items:center;gap:.4rem;'>
        <div style='font-size:.7rem;font-weight:600;letter-spacing:.5px;'>No results</div>
        <div style='font-size:.55rem;opacity:.65;'>Change keywords or filters to try again.</div>
      </div></td></tr>`;
        return 0;
      }
      tbody.innerHTML = rows.map((r, i) => {
        const idx = offset + i + 1;
        const cat = (r.categories || []).join(', ');
        const versions = Array.isArray(r.versions) && r.versions.length
          ? r.versions.join(', ')
          : (r.version || '');
        return `<tr>
        <td class='mono' style='text-align:right;opacity:.7;'>${idx}</td>
        <td class='mono' style='word-break:break-all;'>${r.domain}</td>
        <td>${r.tech_name || ''}</td>
        <td class='nowrap'>${versions || ''}</td>
        <td>${cat || '<span style="opacity:.4">-</span>'}</td>
        <td class='nowrap'>${fmtTime(r.first_seen)}</td>
        <td class='nowrap'>${fmtTime(r.last_seen)}</td>
      </tr>`;
      }).join('');
      return rows.length;
    }

    // Small UI helper functions (prevent runtime errors if shared helpers are absent)
    function updateSummary(renderedCount) {
      try {
        if (isDefaultView) {
          const count = renderedCount || 0;
          summary.textContent = count ? `Showing latest ${count} technologies` : 'Showing latest technologies';
          summary.dataset.mode = 'default';
        } else {
          summary.textContent = totalRows ? (totalRows + ' results') : '';
          summary.dataset.mode = '';
        }
      } catch (_) { }
    }

    function updatePaging() {
      try {
        const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
        pageInfo.textContent = `Page ${currentPage}/${totalPages}`;
        pagingBar.style.display = totalRows > 0 ? 'flex' : 'none';
        btnPrev.disabled = currentPage <= 1; btnFirst.disabled = currentPage <= 1;
        btnNext.disabled = currentPage >= totalPages; btnLast.disabled = currentPage >= totalPages;
      } catch (_) { }
    }

    function persistQueryToURL() {
      try {
        if (isDefaultQueryState()) {
          window.history.replaceState(null, '', window.location.pathname);
          return;
        }
        const qp = buildParams();
        const newUrl = window.location.pathname + '?' + qp.toString();
        window.history.replaceState(null, '', newUrl);
      } catch (_) { }
    }

    function syncSortIndicators() {
      try {
        document.querySelectorAll('#ts-table thead th.sortable').forEach(th => {
          th.classList.remove('sorted-asc', 'sorted-desc');
          if (th.dataset.sort === sortKey) {
            th.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
          }
        });
      } catch (_) { }
    }

    function restoreFromURL() {
      try {
        const params = new URLSearchParams(window.location.search);
        const t = params.get('tech'); const c = params.get('category'); const v = params.get('version');
        if (t) document.getElementById('ts-tech').value = t;
        if (c) document.getElementById('ts-category').value = c;
        if (v) document.getElementById('ts-version').value = v;
        const p = parseInt(params.get('limit') || '', 10);
        if (p) { pageSize = p; pageSizeSel.value = String(p); }
        const off = parseInt(params.get('offset') || '', 10);
        if (!isNaN(off) && pageSize) { currentPage = Math.floor(off / pageSize) + 1; }
        const sortParam = params.get('sort');
        if (sortParam) { sortKey = sortParam; }
        const dirParam = params.get('dir');
        if (dirParam === 'asc' || dirParam === 'desc') { sortDir = dirParam; }
        syncSortIndicators();
        const trackedKeys = ['tech', 'category', 'version', 'limit', 'offset', 'sort', 'dir'];
        const hasTrackedParam = trackedKeys.some(key => params.has(key));
        if (hasTrackedParam) {
          runSearch();
        } else {
          runSearch({ skipPersist: true, forceDefault: true });
        }
      } catch (_) { }
    }

    // Debounce auto-search (450ms) & suggestions debounce (1000ms) with min length 2 (now for tech & category)
    const techInput = document.getElementById('ts-tech');
    const catInput = document.getElementById('ts-category');
    const verInput = document.getElementById('ts-version');
    const suggestBox = document.getElementById('ts-suggest');
    const suggestItemsEl = suggestBox?.querySelector('.sg-items');
    const suggestStatusEl = suggestBox?.querySelector('.sg-status');
    // Category suggestion elements
    const catSuggestBox = document.getElementById('cat-suggest');
    const catItemsEl = catSuggestBox?.querySelector('.cat-items');
    const catStatusEl = catSuggestBox?.querySelector('.cat-status');
    let searchDebounce = null;
    let suggestDebounce = null;
    let catSuggestDebounce = null;
    const SUGGEST_DELAY = 1000; // updated to 1s per request
    const SUGGEST_MIN = 2;
    let activeIndex = -1; // keyboard navigation
    let currentSuggestions = [];
    const suggestCache = {}; // prefix -> array
    const catSuggestCache = {}; // prefix -> categories array
    let lastTechSuggestQuery = '';
    let lastCatSuggestQuery = '';
    function scheduleSearch() {
      currentPage = 1;
      if (searchDebounce) clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => runSearch(), 450);
    }
    function scheduleSuggest() {
      if (!techInput) return;
      const val = techInput.value.trim();
      if (suggestDebounce) clearTimeout(suggestDebounce);
      if (!val || val.length < SUGGEST_MIN) { hideSuggest(); return; }
      showSuggestStatus('Loading...');
      suggestDebounce = setTimeout(() => fetchSuggestions(val), SUGGEST_DELAY);
    }
    function scheduleCatSuggest() {
      if (!catInput) return;
      const val = catInput.value.trim();
      if (catSuggestDebounce) clearTimeout(catSuggestDebounce);
      if (!val || val.length < SUGGEST_MIN) { hideCatSuggest(); return; }
      showCatStatus('Loading...');
      catSuggestDebounce = setTimeout(() => fetchCatSuggestions(val), SUGGEST_DELAY);
    }
    [techInput, catInput, verInput].filter(Boolean).forEach(inp => {
      inp.addEventListener('input', (e) => {
        scheduleSearch();
        if (e.target === techInput) scheduleSuggest();
        if (e.target === catInput) scheduleCatSuggest();
      });
    });

    function hideSuggest() {
      if (!suggestBox) return;
      suggestBox.style.display = 'none';
      if (suggestItemsEl) suggestItemsEl.innerHTML = '';
      if (suggestStatusEl) suggestStatusEl.style.display = 'none';
      activeIndex = -1; currentSuggestions = [];
    }
    function hideCatSuggest() {
      if (!catSuggestBox) return;
      catSuggestBox.style.display = 'none';
      if (catItemsEl) catItemsEl.innerHTML = '';
      if (catStatusEl) catStatusEl.style.display = 'none';
    }
    function showSuggestStatus(text) {
      if (!suggestBox || !suggestStatusEl) return;
      suggestStatusEl.textContent = text;
      suggestStatusEl.style.display = 'block';
      suggestBox.style.display = 'block';
    }
    function showCatStatus(text) {
      if (!catSuggestBox || !catStatusEl) return;
      catStatusEl.textContent = text;
      catStatusEl.style.display = 'block';
      catSuggestBox.style.display = 'block';
    }
    function showSuggestItems() {
      if (!suggestBox || !suggestItemsEl) return;
      suggestStatusEl && (suggestStatusEl.style.display = 'none');
      suggestBox.style.display = 'block';
    }
    function showCatItems() {
      if (!catSuggestBox || !catItemsEl) return;
      catStatusEl && (catStatusEl.style.display = 'none');
      catSuggestBox.style.display = 'block';
    }

    async function fetchSuggestions(prefix) {
      if (!suggestBox || !suggestItemsEl) return;
      const query = prefix.trim();
      if (!query) {
        hideSuggest();
        return;
      }
      lastTechSuggestQuery = query;
      const cacheKey = query.toLowerCase();
      if (Array.isArray(suggestCache[cacheKey])) {
        renderSuggestList(query, suggestCache[cacheKey]);
        return;
      }
      showSuggestStatus('Loading...');
      try {
        const params = new URLSearchParams({ prefix: query, limit: '12' });
        const data = await apiFetch('/tech_suggest?' + params.toString());
        if (lastTechSuggestQuery !== query) {
          return; // stale response
        }
        const list = Array.isArray(data?.suggestions) ? data.suggestions.filter(Boolean) : [];
        suggestCache[cacheKey] = list;
        renderSuggestList(query, list);
      } catch (err) {
        if (lastTechSuggestQuery !== query) {
          return;
        }
        console.warn('[TechSearch] gagal memuat saran teknologi', err);
        showSuggestStatus('Tidak bisa memuat saran');
      }
    }

    function renderSuggestList(prefix, list) {
      if (!suggestItemsEl) return;
      const entries = Array.isArray(list) ? list.map(v => (v == null ? '' : String(v))).filter(Boolean) : [];
      currentSuggestions = entries;
      activeIndex = -1;
      if (!entries.length) {
        suggestItemsEl.innerHTML = '';
        showSuggestStatus('Tidak ada saran');
        return;
      }
      const html = entries.map((name, i) => {
        const label = highlightWithTerm(name, prefix);
        return `<div class='sg-item' data-idx='${i}' data-val="${escapeHTML(name)}" style='padding:6px 8px;font-size:.6rem;cursor:pointer;display:flex;align-items:center;gap:.4rem;'>${label}</div>`;
      }).join('');
      suggestItemsEl.innerHTML = html;
      showSuggestItems();
      suggestBox.querySelectorAll('.sg-item').forEach(div => {
        div.addEventListener('mouseenter', () => setActive(parseInt(div.dataset.idx, 10)));
        div.addEventListener('click', () => selectActive(parseInt(div.dataset.idx, 10)));
      });
    }

    async function fetchCatSuggestions(prefix) {
      if (!catSuggestBox || !catItemsEl) return;
      const query = prefix.trim();
      if (!query) {
        hideCatSuggest();
        return;
      }
      lastCatSuggestQuery = query;
      const cacheKey = query.toLowerCase();
      if (Array.isArray(catSuggestCache[cacheKey])) {
        renderCatSuggestionList(query, catSuggestCache[cacheKey]);
        return;
      }
      showCatStatus('Loading...');
      try {
        const params = new URLSearchParams({ prefix: query, limit: '12' });
        const data = await apiFetch('/category_suggest?' + params.toString());
        if (lastCatSuggestQuery !== query) {
          return;
        }
        const list = Array.isArray(data?.suggestions) ? data.suggestions.filter(Boolean) : [];
        catSuggestCache[cacheKey] = list;
        renderCatSuggestionList(query, list);
      } catch (err) {
        if (lastCatSuggestQuery !== query) {
          return;
        }
        console.warn('[TechSearch] gagal memuat saran kategori', err);
        showCatStatus('Tidak bisa memuat saran');
      }
    }

    function renderCatSuggestionList(prefix, list) {
      if (!catItemsEl) { return; }
      const entries = Array.isArray(list) ? list.map(v => (v == null ? '' : String(v))).filter(Boolean) : [];
      if (!entries.length) {
        catItemsEl.innerHTML = '';
        showCatStatus('Tidak ada saran');
        return;
      }
      const html = entries.map((c, i) => {
        const label = highlightWithTerm(c, prefix);
        return `<div class='cat-item' data-idx='${i}' data-val="${escapeHTML(c)}" style='padding:6px 8px;font-size:.6rem;cursor:pointer;'>${label}</div>`;
      }).join('');
      catItemsEl.innerHTML = html;
      showCatItems();
      catSuggestBox.querySelectorAll('.cat-item').forEach(div => {
        div.addEventListener('click', () => {
          catInput.value = div.getAttribute('data-val');
          hideCatSuggest();
          currentPage = 1; runSearch();
        });
      });
    }

    function setActive(idx) {
      if (!suggestItemsEl) return;
      activeIndex = idx;
      suggestItemsEl.querySelectorAll('.sg-item').forEach(el => el.style.background = '');
      const el = suggestItemsEl.querySelector(`.sg-item[data-idx='${idx}']`);
      if (el) el.style.background = '#20303b';
    }
    function moveActive(delta) {
      if (!currentSuggestions.length) { return; }
      if (activeIndex === -1) { activeIndex = delta > 0 ? 0 : currentSuggestions.length - 1; }
      else { activeIndex = (activeIndex + delta + currentSuggestions.length) % currentSuggestions.length; }
      setActive(activeIndex);
    }
    function selectActive(idxOverride) {
      const idx = typeof idxOverride === 'number' ? idxOverride : activeIndex;
      if (idx < 0 || idx >= currentSuggestions.length) return;
      const val = currentSuggestions[idx];
      techInput.value = val;
      hideSuggest();
      currentPage = 1; runSearch();
    }

    // Hide suggestions on outside click / escape
    document.addEventListener('click', (e) => {
      if (!suggestBox || !techInput) return;
      if (suggestBox.contains(e.target) || e.target === techInput) return;
      hideSuggest();
    });
    document.addEventListener('click', (e) => {
      if (!catSuggestBox || !catInput) return;
      if (catSuggestBox.contains(e.target) || e.target === catInput) return;
      hideCatSuggest();
    });
    techInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { hideSuggest(); return; }
      if (e.key === 'ArrowDown') { moveActive(1); e.preventDefault(); }
      else if (e.key === 'ArrowUp') { moveActive(-1); e.preventDefault(); }
      else if (e.key === 'Enter' && suggestBox && suggestBox.style.display !== 'none' && activeIndex >= 0) {
        e.preventDefault(); selectActive(activeIndex);
      }
    });
    catInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { hideCatSuggest(); return; }
      if (e.key === 'Enter' && catSuggestBox && catSuggestBox.style.display !== 'none') {
        const first = catItemsEl?.querySelector('.cat-item[data-idx="0"]');
        if (first) {
          catInput.value = first.getAttribute('data-val');
          hideCatSuggest(); currentPage = 1; runSearch(); e.preventDefault();
        }
      }
    });

    // If user manually clicks Search, cancel pending debounce to avoid duplicate
    document.getElementById('ts-submit')?.addEventListener('click', () => {
      if (searchDebounce) { clearTimeout(searchDebounce); searchDebounce = null; }
    });
    pageSizeSel?.addEventListener('change', () => {
      const newSize = parseInt(pageSizeSel.value, 10) || pageSize;
      if (newSize !== pageSize) {
        pageSize = newSize;
        currentPage = 1;
        runSearch();
      }
    });
    btnPrev?.addEventListener('click', () => { if (currentPage > 1) { currentPage--; runSearch(); } });
    btnNext?.addEventListener('click', () => { currentPage++; runSearch(); });
    btnFirst?.addEventListener('click', () => { if (currentPage !== 1) { currentPage = 1; runSearch(); } });
    btnLast?.addEventListener('click', () => { const tp = Math.max(1, Math.ceil(totalRows / pageSize)); if (currentPage !== tp) { currentPage = tp; runSearch(); } });

    document.querySelectorAll('#ts-table thead th.sortable').forEach(th => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', () => {
        const k = th.dataset.sort;
        if (sortKey === k) { sortDir = (sortDir === 'asc' ? 'desc' : 'asc'); }
        else { sortKey = k; sortDir = 'asc'; }
        currentPage = 1; runSearch();
        syncSortIndicators();
      });
    });

    restoreFromURL();
    document.getElementById('ts-tech')?.focus();
  });
</script>
{% endblock %}