<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechScan Lookup</title>
  <style>
    :root {
      --bg:#0f1115;--panel:#1b1f27;--panel-alt:#222834;--border:#2e3644;--accent:#3b82f6;--accent-hover:#2563eb;--text:#f1f5f9;--text-dim:#94a3b8;--danger:#ef4444;--warn:#f59e0b;--ok:#10b981;--radius:10px;--focus-ring:0 0 0 3px rgba(59,130,246,.35)
    }
    * {box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;}
    body {margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
    h1 {font-size:2.2rem;margin:0 0 1rem;font-weight:600;}
    a {color:var(--accent);text-decoration:none}
    a:hover{color:var(--accent-hover)}
    header {padding:2.5rem 2rem 1.2rem;max-width:1040px;margin:0 auto;}
    .subtitle {color:var(--text-dim);font-size:.95rem;max-width:760px;line-height:1.4}
    main {max-width:1040px;margin:0 auto;padding:0 2rem 4rem;}
  .panel {background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:1.15rem 1.15rem 1.25rem;margin-bottom:1.2rem;box-shadow:0 4px 12px -4px rgba(0,0,0,.35)}
  .panel h2 {font-size:1.02rem;margin:0 0 .75rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text-dim)}
  form.inline {display:flex;gap:.6rem;flex-wrap:wrap;align-items:flex-start}
    input[type=text]{flex:1 1 360px;background:var(--panel-alt);border:1px solid var(--border);color:var(--text);padding:.85rem 1rem;border-radius:8px;font-size:.95rem;outline:none;}
    input[type=text]:focus{border-color:var(--accent);box-shadow:var(--focus-ring);}
  button{cursor:pointer;background:var(--accent);color:var(--text);border:none;padding:.75rem 1.05rem;font-size:.9rem;border-radius:8px;font-weight:600;display:inline-flex;align-items:center;gap:.45rem;letter-spacing:.3px;}
    button:hover{background:var(--accent-hover)}
    button.secondary{background:var(--panel-alt);border:1px solid var(--border);color:var(--text-dim);}
    button.secondary:hover{border-color:var(--accent);color:var(--text)}
  .results-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:.75rem;margin-top:1.1rem}
  .tech{background:var(--panel-alt);border:1px solid var(--border);padding:.9rem .95rem .95rem;border-radius:10px;display:flex;flex-direction:column;gap:.55rem;min-height:150px}
    .tech h3{margin:0;font-size:.92rem;font-weight:600;line-height:1.25}
    .tech .version{font-size:.72rem;color:var(--accent);font-weight:500}
  .tech-icon,.tech-logo{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:600;letter-spacing:.5px;background:#334155;color:#fff}
  .tech-logo{overflow:hidden;background:#1e2530}
  .tech-logo img{max-width:100%;max-height:100%;display:block}
  .tech-head{display:flex;align-items:flex-start;gap:.7rem}
  .badge-row{display:flex;flex-wrap:wrap;gap:.3rem}
    .badge{background:#2f3a4a;color:var(--text-dim);padding:.25rem .55rem;border-radius:999px;font-size:.65rem;letter-spacing:.5px;text-transform:uppercase}
    .status-bar{font-size:.7rem;position:absolute;top:6px;right:8px;color:var(--text-dim)}
    pre{background:#0d0f12;border:1px solid var(--border);padding:1rem;border-radius:8px;overflow:auto;font-size:.75rem;line-height:1.3;max-height:340px}
    .flex-row{display:flex;gap:1rem;flex-wrap:wrap}
    .col{flex:1 1 380px;min-width:320px}
    .hidden{display:none}
    .error{color:var(--danger);margin-top:.5rem;font-size:.8rem}
    .table-wrap{overflow:auto;max-height:420px}
    table{border-collapse:collapse;width:100%;font-size:.8rem}
    th,td{padding:.45rem .55rem;text-align:left;border-bottom:1px solid var(--border)}
    th{background:var(--panel-alt);position:sticky;top:0}
    .categories-list{display:flex;flex-direction:column;gap:.65rem;margin-top:.9rem}
    .cat-block{background:var(--panel-alt);border:1px solid var(--border);padding:.7rem .85rem;border-radius:8px}
    .cat-block h4{margin:0 0 .5rem;font-size:.75rem;letter-spacing:.5px;color:var(--text-dim);text-transform:uppercase}
    footer{max-width:1040px;margin:2rem auto 4rem;padding:0 2rem;font-size:.65rem;color:var(--text-dim);text-align:center}
    input[type=file]{display:none}
    .file-label{background:var(--panel-alt);border:1px dashed var(--border);padding:1rem;border-radius:8px;cursor:pointer;text-align:center;font-size:.8rem;color:var(--text-dim)}
    .spinner{width:18px;height:18px;border:3px solid #1f2933;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  .new-domain{background:rgba(16,185,129,0.08)}
  .new-domain td{position:relative}
  .new-chip{background:var(--ok);color:#fff;padding:0 .4rem;border-radius:999px;font-size:.55rem;letter-spacing:.5px;margin-left:.35rem}
    @media (max-width:680px){header{padding:2rem 1.2rem 1rem}main{padding:0 1.2rem 3rem}}
  </style>
</head>
<body>
  <header>
    <!-- Legacy index.html intentionally blank after migration to multi-page UI.
    Keperluan: beberapa browser mungkin masih meminta /index.html secara langsung.
    Tindakan: redirect ditangani di route Flask (/index.html -> /dashboard). File kosong ini mencegah fallback ke UI lama.
    -->
          <tbody></tbody>
        </table>
        <div style="display:flex;gap:.6rem;margin-top:.6rem;align-items:center;font-size:.7rem;flex-wrap:wrap">
          <button type="button" id="history-prev" class="secondary" style="padding:.4rem .7rem">Prev</button>
          <button type="button" id="history-next" class="secondary" style="padding:.4rem .7rem">Next</button>
          <label style="display:flex;align-items:center;gap:.25rem">Page <input type="number" id="history-page-jump" min="1" value="1" style="width:65px;background:var(--panel-alt);border:1px solid var(--border);color:var(--text);padding:.3rem .4rem;border-radius:6px;font-size:.65rem" /></label>
          <button type="button" id="history-go" class="secondary" style="padding:.35rem .6rem">Go</button>
          <span id="history-page-info" style="color:var(--text-dim)"></span>
        </div>
      </div>
    </section>
    <section class="panel" id="search-panel">
      <h2>Search Technology</h2>
      <form class="inline" id="search-form">
        <input type="text" id="search-tech" placeholder="Nama teknologi (misal: Laravel)" required />
        <input type="text" id="search-version" placeholder="Versi (opsional)" style="flex:0 0 140px;background:var(--panel-alt);border:1px solid var(--border);color:var(--text);padding:.85rem .8rem;border-radius:8px;font-size:.75rem" />
        <input type="text" id="search-category" placeholder="Kategori (opsional)" style="flex:0 0 150px;background:var(--panel-alt);border:1px solid var(--border);color:var(--text);padding:.85rem .8rem;border-radius:8px;font-size:.75rem" />
        <label style="display:flex;align-items:center;gap:.35rem;font-size:.65rem;color:var(--text-dim)"><input type="checkbox" id="search-new24" style="accent-color:var(--accent)" /> NEW 24h</label>
        <input type="number" id="search-limit" placeholder="Limit" min="1" value="50" style="flex:0 0 80px;background:var(--panel-alt);border:1px solid var(--border);color:var(--text);padding:.85rem .8rem;border-radius:8px;font-size:.75rem" />
        <button type="submit">Search</button>
      </form>
      <div id="search-error" class="error hidden" style="margin-top:.5rem"></div>
      <div class="table-wrap hidden" id="search-table-wrap" style="margin-top:.8rem">
        <table id="search-table">
          <thead>
            <tr><th>Domain</th><th>Tech</th><th>Version</th><th>Categories</th><th>First Seen</th><th>Last Seen</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="display:flex;gap:.6rem;margin-top:.6rem;align-items:center;font-size:.7rem;flex-wrap:wrap">
          <button type="button" id="search-prev" class="secondary" style="padding:.4rem .7rem">Prev</button>
          <button type="button" id="search-next" class="secondary" style="padding:.4rem .7rem">Next</button>
          <label style="display:flex;align-items:center;gap:.25rem">Page <input type="number" id="search-page-jump" min="1" value="1" style="width:65px;background:var(--panel-alt);border:1px solid var(--border);color:var(--text);padding:.3rem .4rem;border-radius:6px;font-size:.65rem" /></label>
          <button type="button" id="search-go" class="secondary" style="padding:.35rem .6rem">Go</button>
          <span id="search-page-info" style="color:var(--text-dim)"></span>
        </div>
      </div>
    </section>
    <section class="panel" id="domain-panel">
      <h2>Cari Domain (Current Tech)</h2>
      <form class="inline" id="domain-form">
        <input type="text" id="lookup-domain" placeholder="Domain untuk lookup" required />
        <button type="submit">Lookup</button>
      </form>
      <div id="domain-error" class="error hidden" style="margin-top:.5rem"></div>
      <div id="domain-result" class="hidden" style="margin-top:.9rem">
        <h3 style="margin:0 0 .6rem;font-size:.85rem" id="domain-res-title"></h3>
        <div class="results-grid" id="domain-tech-grid"></div>
        <details style="margin-top:1rem"><summary style="cursor:pointer;color:var(--text-dim);font-size:.7rem">Categories</summary>
          <div id="domain-cat" class="categories-list" style="margin-top:.6rem"></div>
        </details>
      </div>
    </section>
    <section class="panel" id="diff-panel">
      <h2>Diff Last 2 Scans</h2>
      <p style="margin:.2rem 0 .8rem;font-size:.65rem;color:var(--text-dim)">Menunjukkan perbedaan teknologi antara dua scan terakhir untuk domain: teknologi baru (Added), hilang (Removed), dan berubah versi (Changed). Berguna memantau update atau perubahan stack.</p>
      <form class="inline" id="diff-form">
        <input type="text" id="diff-domain" placeholder="Domain untuk diff" required />
        <button type="submit">Load Diff</button>
      </form>
      <div id="diff-error" class="error hidden" style="margin-top:.5rem"></div>
      <div id="diff-result" class="hidden" style="margin-top:.8rem;font-size:.75rem;display:flex;flex-direction:column;gap:.9rem">
        <div id="diff-meta" style="color:var(--text-dim)"></div>
        <div style="display:flex;flex-wrap:wrap;gap:1.2rem">
          <div style="flex:1 1 260px;min-width:220px">
            <h3 style="margin:.2rem 0 .4rem;font-size:.8rem;color:var(--text-dim);text-transform:uppercase">Added</h3>
            <ul id="diff-added" style="margin:0;padding-left:1.1rem"></ul>
          </div>
          <div style="flex:1 1 260px;min-width:220px">
            <h3 style="margin:.2rem 0 .4rem;font-size:.8rem;color:var(--text-dim);text-transform:uppercase">Removed</h3>
            <ul id="diff-removed" style="margin:0;padding-left:1.1rem"></ul>
          </div>
          <div style="flex:1 1 260px;min-width:220px">
            <h3 style="margin:.2rem 0 .4rem;font-size:.8rem;color:var(--text-dim);text-transform:uppercase">Changed</h3>
            <ul id="diff-changed" style="margin:0;padding-left:1.1rem"></ul>
          </div>
        </div>
      </div>
    </section>
  </main>
  <footer>
    Built with Flask + Wappalyzer (local). Detection accuracy depends on exposed artefacts. Cache TTL 5m.
  </footer>
  <script>
    async function postJSON(url, data){
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      const txt = await r.text();
      let j; try { j = JSON.parse(txt); } catch { throw new Error('Invalid JSON'); }
      if(!r.ok) throw new Error(j.error || 'Request failed');
      return j;
    }

    // Simple deterministic color map for tech icons (hash first char groups)
    function iconColorFor(name){
      const palette = ['#3b82f6','#6366f1','#8b5cf6','#ec4899','#f59e0b','#10b981','#0ea5e9','#ef4444','#14b8a6','#84cc16'];
      if(!name) return '#475569';
      let h=0; for(let i=0;i<name.length;i++){ h = (h*31 + name.charCodeAt(i))>>>0; }
      return palette[h % palette.length];
    }

    const form = document.getElementById('single-form');
    const domainInput = document.getElementById('domain');
  const modeSelect = document.getElementById('mode');
    const resDiv = document.getElementById('single-result');
    const techGrid = document.getElementById('tech-grid');
    const rawPre = document.getElementById('raw-json');
    const catDiv = document.getElementById('categories');
    const resDomain = document.getElementById('res-domain');
    const errorBox = document.getElementById('single-error');
    const scanBtnText = document.getElementById('scanBtnText');
    const scanSpinner = document.getElementById('scanSpinner');
  const diagPre = document.getElementById('diag-json');

  // History elements
  const historyForm = document.getElementById('history-form');
  const historyDomain = document.getElementById('history-domain');
  const historyLimit = document.getElementById('history-limit');
  const historyErr = document.getElementById('history-error');
  const historyWrap = document.getElementById('history-table-wrap');
  const historyTbody = document.querySelector('#history-table tbody');
  const historyRefreshBtn = document.getElementById('history-refresh');
  const historyPrev = document.getElementById('history-prev');
  const historyNext = document.getElementById('history-next');
  const historyPageInfo = document.getElementById('history-page-info');
  const historyPageJump = document.getElementById('history-page-jump');
  const historyGo = document.getElementById('history-go');
  let _lastHistory = {domain:null, limit:10, total:0};
  let _historyOffset = 0;

  function disableNextHistory(){
    if(!_lastHistory.total) return false;
    const nextOffset = _historyOffset + _lastHistory.limit;
    return nextOffset >= _lastHistory.total;
  }
  function updateHistoryPageInfo(){
    const page = Math.floor(_historyOffset / _lastHistory.limit) + 1;
    const totalPages = _lastHistory.total ? Math.max(1, Math.ceil(_lastHistory.total / _lastHistory.limit)) : '?';
    historyPageJump.value = page;
    historyPageInfo.textContent = `Page ${page}/${totalPages} | Offset ${_historyOffset}${_lastHistory.total? ' | Total '+_lastHistory.total:''}`;
    historyPrev.disabled = _historyOffset === 0;
    historyNext.disabled = disableNextHistory();
  }
  historyPrev.addEventListener('click', ()=>{ if(!_lastHistory.domain) return; _historyOffset = Math.max(0, _historyOffset - _lastHistory.limit); historyRefreshBtn.click(); });
  historyNext.addEventListener('click', ()=>{ if(!_lastHistory.domain) return; if(disableNextHistory()) return; _historyOffset += _lastHistory.limit; historyRefreshBtn.click(); });
  historyGo.addEventListener('click', ()=>{ if(!_lastHistory.domain) return; const p = parseInt(historyPageJump.value); if(!p||p<1) return; _historyOffset = (p-1)*_lastHistory.limit; historyRefreshBtn.click(); });

  // Search elements
  const searchForm = document.getElementById('search-form');
  const searchTech = document.getElementById('search-tech');
  const searchVersion = document.getElementById('search-version');
  const searchCategory = document.getElementById('search-category');
  const searchLimit = document.getElementById('search-limit');
  const searchNew24 = document.getElementById('search-new24');
  const searchErr = document.getElementById('search-error');
  const searchWrap = document.getElementById('search-table-wrap');
  const searchTbody = document.querySelector('#search-table tbody');
  const searchTable = document.getElementById('search-table');
  const searchPrev = document.getElementById('search-prev');
  const searchNext = document.getElementById('search-next');
  const searchPageInfo = document.getElementById('search-page-info');
  const searchPageJump = document.getElementById('search-page-jump');
  const searchGo = document.getElementById('search-go');
  let _searchData = [];
  let _searchSort = {key:'last_seen', dir:'desc'};
  let _searchOffset = 0;
  let _searchQueryState = {tech:null, version:null, category:null, limit:50, total:0, new24:false};

    function setLoading(state){
      if(state){
        scanBtnText.textContent='Scanning';
        scanSpinner.classList.remove('hidden');
      } else {
        scanBtnText.textContent='Scan';
        scanSpinner.classList.add('hidden');
      }
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const domain = domainInput.value.trim().toLowerCase();
      if(!domain) return;
      errorBox.classList.add('hidden');
      setLoading(true);
      try {
  const mode = modeSelect.value;
  const body = {domain};
  if(mode==='quick') body.quick = 1;
  else if(mode==='fast_full') body.fast_full = 1;
  else if(mode==='deep') body.deep = 1;
  else if(mode==='full') body.full = 1;
  // Quick mode: always request fresh to ensure enrichment/version evidence current
  if(mode==='quick') body.fresh = 1;
  const data = await postJSON('/scan', body);
        renderSingle(domain, data);
      } catch (err) {
        errorBox.textContent = err.message;
        errorBox.classList.remove('hidden');
      } finally { setLoading(false); }
    });

    function synthesizeCategories(data){
      if(!data) return;
      if(data.categories && Object.keys(data.categories).length) return; // already present
      const cats = {};
      (data.technologies||[]).forEach(t=>{
        (t.categories||[]).forEach(c=>{
          cats[c] = cats[c] || [];
          if(!cats[c].some(x=>x.name===t.name && x.version===t.version)){
            cats[c].push({name:t.name, version:t.version});
          }
        });
      });
      if(Object.keys(cats).length){
        data.categories = cats;
      }
    }

    // CDN icon integration only (user request) with letter fallback.
  const ICON_REMOTE_BASE = 'https://unpkg.com/tech-stack-icons@3.3.2/icons';
    const REMOTE_ICON_MAP = {
      'wordpress':'wordpress',
      'react':'react',
      'laravel':'laravel',
      'vue.js':'vue', 'vue':'vue',
      'angular':'angular',
      'tailwind css':'tailwindcss', 'tailwind':'tailwindcss',
      'php':'php',
      'mysql':'mysql',
      'redis':'redis',
      'nginx':'nginx',
      'apache':'apache',
      'cloudflare':'cloudflare',
      'express':'express',
      'drupal':'drupal',
      'joomla':'joomla',
      'woocommerce':'woocommerce',
      'jquery':'jquery',
      'next.js':'nextjs','nextjs':'nextjs',
      'nuxt.js':'nuxtjs','nuxtjs':'nuxtjs'
    };

    const failCounts = {};
    function fallbackIcon(img){
      try{
        const name = img.dataset.tech || '?';
        const key = name.toLowerCase();
        // Record failed remote icon if it looks like a remote src. Only persist after 2 consecutive failures this session.
        if(img.src.startsWith(ICON_REMOTE_BASE)){
          failCounts[key] = (failCounts[key]||0)+1;
          if(failCounts[key] >= 2){
            failedRemoteIcons.add(key);
            try { localStorage.setItem('techscan_failed_remote_icons', JSON.stringify(Array.from(failedRemoteIcons))); } catch(_){ }
          }
        }
        const parent = img.parentElement;
        if(parent){
          const letter = name.charAt(0).toUpperCase();
          const color = iconColorFor(name);
            parent.innerHTML = `<div class='tech-icon' style="background:${color}">${letter}</div>`;
        }
      }catch(_e){/* noop */}
    }

    let failedRemoteIcons = new Set(); // simple session-level only now
    function techIconHTML(name, version){
      if(!name) return null;
      const key = name.toLowerCase();
      const title = version ? `${name} ${version}` : name;
      if(REMOTE_ICON_MAP[key] && !failedRemoteIcons.has(key)){
        const remotePath = `${ICON_REMOTE_BASE}/${REMOTE_ICON_MAP[key]}.svg`;
        return `<div class='tech-logo'><img src='${remotePath}' alt='${name} logo' title='${title}' data-tech='${name}' data-version='${version||''}' onerror='fallbackIcon(this)'/></div>`;
      }
      const letter = name.charAt(0).toUpperCase();
      const color = iconColorFor(name);
      return `<div class='tech-icon' style="background:${color}" title='${title}'>${letter}</div>`;
    }

    // Rerender helpers when toggle changes
    let _lastSingleData = null; let _lastSingleDomain = null;
    let _lastDomainLookup = null; // {domain, data}
    function reRenderAfterToggle(){
      if(_lastSingleData && _lastSingleDomain){
        renderSingle(_lastSingleDomain, _lastSingleData);
      }
      if(_lastDomainLookup){
        renderDomainLookup(_lastDomainLookup.domain, _lastDomainLookup.data);
      }
    }
    // Preload a few common icons (session only)
    ['wordpress','react','laravel','vue','angular','tailwindcss','php','mysql','redis'].forEach(k=>{
      if(!REMOTE_ICON_MAP[k]) return; const img = new Image(); img.src = `${ICON_REMOTE_BASE}/${REMOTE_ICON_MAP[k]}.svg`;
    });

    function renderSingle(domain, data){
      _lastSingleData = data; _lastSingleDomain = domain;
      synthesizeCategories(data); // ensure categories fallback if backend still empty
      resDiv.classList.remove('hidden');
      resDomain.textContent = domain + (data.cached ? ' (cached)' : '');
      techGrid.innerHTML='';
      (data.technologies||[]).forEach(t=>{
        const el = document.createElement('div');
        el.className='tech has-icon';
        el.innerHTML = `<div class='tech-head'>${techIconHTML(t.name||'', t.version)}<div style='display:flex;flex-direction:column;gap:.3rem'><h3>${t.name||''}</h3>`+
          (t.version?`<div class='version'>${t.version}</div>`:'')+`</div></div>`+
          `<div class='badge-row'>${(t.categories||[]).map(c=>`<span class='badge'>${c}</span>`).join('')}</div>`;
        techGrid.appendChild(el);
      });
      catDiv.innerHTML='';
      const cats = data.categories || {};
      Object.keys(cats).sort().forEach(c=>{
        const block = document.createElement('div');
        block.className='cat-block';
        block.innerHTML = `<h4>${c}</h4><div class='badge-row'>` +
          cats[c].map(x=>`<span class='badge'>${x.name}${x.version?' '+x.version:''}</span>`).join('') + '</div>';
        catDiv.appendChild(block);
      });
      rawPre.textContent = JSON.stringify(data.raw || {}, null, 2);
    }

      async function fetchDiag(params){
        const qs = Object.entries(params).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
        const r = await fetch(`/admin/quick_diag?${qs}`);
        const t = await r.text();
        let j; try { j = JSON.parse(t); } catch { throw new Error('Invalid JSON diag'); }
        if(!r.ok){ throw new Error(j.error || 'Diag failed'); }
        return j;
      }

      // Diagnostics buttons removed for simplified UI; keep function available if needed later.

      function fmt(ts){
        if(!ts && ts!==0) return '-';
        try { return new Date(ts*1000).toLocaleString(); } catch { return ts; }
      }

      historyForm.addEventListener('submit', async e => {
        e.preventDefault();
        const dom = historyDomain.value.trim().toLowerCase();
        if(!dom) return;
        historyErr.classList.add('hidden');
        historyWrap.classList.add('hidden');
        historyTbody.innerHTML = '';
        try {
          const limit = parseInt(historyLimit.value)||10;
          _lastHistory = {domain: dom, limit, total:0};
          _historyOffset = 0;
          const r = await fetch(`/history?domain=${encodeURIComponent(dom)}&limit=${limit}&offset=${_historyOffset}`);
          const txt = await r.text();
          let j; try { j = JSON.parse(txt); } catch { throw new Error('Invalid JSON'); }
          if(!r.ok) throw new Error(j.error || 'History failed');
          _lastHistory.total = j.total || 0;
          ;(j.history||[]).forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.mode}</td>`+
              `<td>${fmt(item.started_at)}</td>`+
              `<td>${fmt(item.finished_at)}</td>`+
              `<td>${item.duration_ms}</td>`+
              `<td>${item.from_cache? 'yes':'no'}</td>`+
              `<td>${item.retries}</td>`+
              `<td>${item.timeout_used}</td>`;
            historyTbody.appendChild(tr);
          });
          historyWrap.classList.remove('hidden');
          updateHistoryPageInfo();
          if(!(j.history||[]).length){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" style="color:var(--text-dim);font-style:italic">No history</td>';
            historyTbody.appendChild(tr);
          }
        } catch(err){
          historyErr.textContent = err.message;
          historyErr.classList.remove('hidden');
        }
      });

      historyRefreshBtn.addEventListener('click', async () => {
        if(!_lastHistory.domain){
          historyErr.textContent='Belum ada histori yang dimuat.';
          historyErr.classList.remove('hidden');
          return;
        }
        // trigger fetch with stored state
        historyErr.classList.add('hidden');
        historyWrap.classList.add('hidden');
        historyTbody.innerHTML='';
        try {
          const r = await fetch(`/history?domain=${encodeURIComponent(_lastHistory.domain)}&limit=${_lastHistory.limit}&offset=${_historyOffset}`);
          const txt = await r.text(); let j; try { j = JSON.parse(txt);} catch { throw new Error('Invalid JSON'); }
          if(!r.ok) throw new Error(j.error || 'History failed');
          ;(j.history||[]).forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.mode}</td>`+
              `<td>${fmt(item.started_at)}</td>`+
              `<td>${fmt(item.finished_at)}</td>`+
              `<td>${item.duration_ms}</td>`+
              `<td>${item.from_cache? 'yes':'no'}</td>`+
              `<td>${item.retries}</td>`+
              `<td>${item.timeout_used}</td>`;
            historyTbody.appendChild(tr);
          });
          historyWrap.classList.remove('hidden');
          if(j.total !== undefined) _lastHistory.total = j.total;
          updateHistoryPageInfo();
          if(!(j.history||[]).length){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" style="color:var(--text-dim);font-style:italic">No history</td>';
            historyTbody.appendChild(tr);
          }
        } catch(err){
          historyErr.textContent = err.message;
          historyErr.classList.remove('hidden');
        }
      });

      searchForm.addEventListener('submit', async e => {
        e.preventDefault();
        const tech = searchTech.value.trim();
        if(!tech) return;
        searchErr.classList.add('hidden');
        searchWrap.classList.add('hidden');
        searchTbody.innerHTML='';
        const params = new URLSearchParams();
        params.set('tech', tech);
        const ver = searchVersion.value.trim(); if(ver) params.set('version', ver);
        const cat = searchCategory.value.trim(); if(cat) params.set('category', cat);
        const lim = parseInt(searchLimit.value)||50; params.set('limit', lim);
        if(searchNew24 && searchNew24.checked) params.set('new24','1');
        try {
          _searchOffset = 0;
          _searchQueryState = {tech, version:ver||null, category:cat||null, limit:lim, total:0, new24: (searchNew24? searchNew24.checked:false)};
          params.set('offset', _searchOffset);
          const r = await fetch(`/search?${params.toString()}`);
          const txt = await r.text(); let j; try { j = JSON.parse(txt);} catch { throw new Error('Invalid JSON'); }
          if(!r.ok) throw new Error(j.error || 'Search failed');
          _searchData = j.results||[]; _searchQueryState.total = j.total || 0;
          renderSearchTable();
          searchWrap.classList.remove('hidden');
          if(!(j.results||[]).length){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="6" style="color:var(--text-dim);font-style:italic">No results</td>';
            searchTbody.appendChild(tr);
          }
          updateSearchPageInfo();
        } catch(err){
            searchErr.textContent = err.message;
            searchErr.classList.remove('hidden');
        }
      });

      function renderSearchTable(){
        searchTbody.innerHTML='';
        _searchData.forEach(item => {
          const tr = document.createElement('tr');
          const isNew = (Date.now()/1000 - item.first_seen) < 86400;
          if(isNew) tr.classList.add('new-domain');
          tr.innerHTML = `<td>${item.domain}${isNew?'<span class="new-chip">NEW</span>':''}</td>`+
            `<td>${item.tech_name}</td>`+
            `<td>${item.version||''}</td>`+
            `<td>${(item.categories||[]).join(', ')}</td>`+
            `<td>${fmt(item.first_seen)}</td>`+
            `<td>${fmt(item.last_seen)}</td>`;
          searchTbody.appendChild(tr);
        });
      }

      function sortSearch(key){
        if(_searchSort.key === key){
          _searchSort.dir = _searchSort.dir === 'asc' ? 'desc':'asc';
        } else {
          _searchSort.key = key;
          _searchSort.dir = 'asc';
        }
        _searchOffset = 0;
        fetchSearchPage();
      }

      // Attach click handlers to headers
      (function(){
        const headers = searchTable.querySelectorAll('thead th');
        const map = ['domain','tech_name','version','categories','first_seen','last_seen'];
        headers.forEach((th,i)=>{
          th.style.cursor='pointer';
          th.addEventListener('click', ()=>{
            sortSearch(map[i]);
          });
        });
      })();

      function fetchSearchPage(){
        const params = new URLSearchParams();
        params.set('tech', _searchQueryState.tech);
        if(_searchQueryState.version) params.set('version', _searchQueryState.version);
        if(_searchQueryState.category) params.set('category', _searchQueryState.category);
  if(_searchQueryState.new24) params.set('new24','1');
  params.set('limit', _searchQueryState.limit);
  if(_searchSort.key){ params.set('sort', _searchSort.key); params.set('dir', _searchSort.dir); }
        params.set('offset', _searchOffset);
        fetch(`/search?${params.toString()}`)
          .then(r=>r.text().then(t=>({ok:r.ok,text:t})))
          .then(({ok,text})=>{
            let j; try { j = JSON.parse(text);} catch { throw new Error('Invalid JSON'); }
            if(!ok) throw new Error(j.error||'Search failed');
            _searchData = j.results||[]; if(j.total !== undefined) _searchQueryState.total = j.total;
            renderSearchTable();
            updateSearchPageInfo();
            if(!_searchData.length){
              searchTbody.innerHTML = '<tr><td colspan="6" style="color:var(--text-dim);font-style:italic">No results</td></tr>';
            }
          })
          .catch(e=>{
            searchErr.textContent = e.message;
            searchErr.classList.remove('hidden');
          });
      }
  searchPrev.addEventListener('click', ()=>{ if(!_searchQueryState.tech) return; _searchOffset = Math.max(0, _searchOffset - _searchQueryState.limit); fetchSearchPage(); });
  searchNext.addEventListener('click', ()=>{ if(!_searchQueryState.tech) return; if(disableNextSearch()) return; _searchOffset += _searchQueryState.limit; fetchSearchPage(); });
      searchGo.addEventListener('click', ()=>{ if(!_searchQueryState.tech) return; const p = parseInt(searchPageJump.value); if(!p||p<1) return; _searchOffset = (p-1)*_searchQueryState.limit; fetchSearchPage(); });
      function disableNextSearch(){
        if(!_searchQueryState.total) return false;
        const nextOffset = _searchOffset + _searchQueryState.limit;
        return nextOffset >= _searchQueryState.total;
      }
      function updateSearchPageInfo(){
        const page = Math.floor(_searchOffset / _searchQueryState.limit) + 1;
        const totalPages = _searchQueryState.total ? Math.max(1, Math.ceil(_searchQueryState.total / _searchQueryState.limit)) : '?';
        searchPageJump.value = page;
        searchPageInfo.textContent = `Page ${page}/${totalPages} | Offset ${_searchOffset}${_searchQueryState.total? ' | Total '+_searchQueryState.total:''}`;
        searchPrev.disabled = _searchOffset === 0;
        searchNext.disabled = disableNextSearch();
      }
      if(searchNew24){
        searchNew24.addEventListener('change', ()=>{ if(!_searchQueryState.tech) return; searchForm.dispatchEvent(new Event('submit')); });
      }
      function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }
      const autoSearch = debounce(()=>{
        if(!searchTech.value.trim()) return;
        if(!_searchQueryState.tech || searchTech.value.trim() !== _searchQueryState.tech){
          searchForm.dispatchEvent(new Event('submit'));
        } else {
          _searchQueryState.version = searchVersion.value.trim()||null;
          _searchQueryState.category = searchCategory.value.trim()||null;
          _searchQueryState.new24 = searchNew24? searchNew24.checked:false;
          _searchOffset = 0;
          fetchSearchPage();
        }
      }, 500);
      [searchTech, searchVersion, searchCategory].forEach(el=> el.addEventListener('input', autoSearch));

    // Diff logic
    const diffForm = document.getElementById('diff-form');
    const diffDomain = document.getElementById('diff-domain');
    const diffErr = document.getElementById('diff-error');
    const diffResult = document.getElementById('diff-result');
    const diffMeta = document.getElementById('diff-meta');
    const diffAdded = document.getElementById('diff-added');
    const diffRemoved = document.getElementById('diff-removed');
    const diffChanged = document.getElementById('diff-changed');
    diffForm.addEventListener('submit', async e => {
      e.preventDefault();
      diffErr.classList.add('hidden');
      diffResult.classList.add('hidden');
      diffAdded.innerHTML = diffRemoved.innerHTML = diffChanged.innerHTML = '';
      const dom = diffDomain.value.trim().toLowerCase(); if(!dom) return;
      try {
        const r = await fetch(`/diff?domain=${encodeURIComponent(dom)}`);
        const txt = await r.text(); let j; try { j = JSON.parse(txt);} catch { throw new Error('Invalid JSON'); }
        if(!r.ok) throw new Error(j.error || 'Diff failed');
        diffMeta.textContent = `Latest: ${new Date(j.latest_scan*1000).toLocaleString()} | Previous: ${new Date(j.previous_scan*1000).toLocaleString()} | Added ${j.added.length} | Removed ${j.removed.length} | Changed ${j.changed_count} | Unchanged ${j.unchanged_count}`;
        (j.added||[]).forEach(t=>{
          const li = document.createElement('li');
          li.textContent = t.name + (t.version? ' '+t.version:'');
          diffAdded.appendChild(li);
        });
        (j.removed||[]).forEach(t=>{
          const li = document.createElement('li');
            li.textContent = t.name + (t.version? ' '+t.version:'');
            diffRemoved.appendChild(li);
        });
        (j.changed||[]).forEach(c=>{
          const li = document.createElement('li');
          let text = c.name;
          if(c.upgrade_path){
            text += `: ${c.upgrade_path.from||'(none)'} -> ${c.upgrade_path.to||'(none)'} (${c.upgrade_path.direction})`;
          } else {
            if(c.previous_versions && c.current_versions){
              text += `: [${c.previous_versions.join(',')}] -> [${c.current_versions.join(',')}]`;
            }
          }
          diffChanged.appendChild(li); li.textContent = text;
        });
        diffResult.classList.remove('hidden');
      } catch(err){
        diffErr.textContent = err.message;
        diffErr.classList.remove('hidden');
      }
    });
      // persist limit preferences
      (function(){
        const hlim = localStorage.getItem('techscan_history_limit'); if(hlim && !isNaN(parseInt(hlim))) historyLimit.value = hlim;
        const slim = localStorage.getItem('techscan_search_limit'); if(slim && !isNaN(parseInt(slim))) searchLimit.value = slim;
      })();
      historyLimit.addEventListener('change', ()=> localStorage.setItem('techscan_history_limit', historyLimit.value));
      searchLimit.addEventListener('change', ()=> localStorage.setItem('techscan_search_limit', searchLimit.value));
      function updateSortIndicators(){
        const headers = searchTable.querySelectorAll('thead th');
        const map = ['domain','tech_name','version','categories','first_seen','last_seen'];
        headers.forEach((th,i)=>{
          const key = map[i];
          const base = th.textContent.replace(/\s*[▲▼]$/,'');
          th.textContent = base;
          if(_searchSort.key === key){ th.textContent = base + (_searchSort.dir==='asc'? ' ▲':' ▼'); }
        });
      }

    // Domain lookup panel
    const domainForm = document.getElementById('domain-form');
    const lookupDomain = document.getElementById('lookup-domain');
    const domainError = document.getElementById('domain-error');
    const domainResult = document.getElementById('domain-result');
    const domainTitle = document.getElementById('domain-res-title');
    const domainTechGrid = document.getElementById('domain-tech-grid');
    const domainCatDiv = document.getElementById('domain-cat');
    domainForm.addEventListener('submit', async e => {
      e.preventDefault();
      const dom = lookupDomain.value.trim().toLowerCase();
      if(!dom) return;
      domainError.classList.add('hidden');
      domainResult.classList.add('hidden');
      domainTechGrid.innerHTML='';
      domainCatDiv.innerHTML='';
      try {
        const r = await fetch(`/domain?domain=${encodeURIComponent(dom)}`);
        const txt = await r.text(); let j; try { j = JSON.parse(txt);} catch { throw new Error('Invalid JSON'); }
        if(!r.ok) throw new Error(j.error || 'Lookup failed');
        domainTitle.textContent = `${j.domain} (${j.count} tech)`;
        renderDomainLookup(j.domain, j);
        const cats = j.categories || {};
        Object.keys(cats).sort().forEach(c=>{
          const block = document.createElement('div');
          block.className='cat-block';
          block.innerHTML = `<h4>${c}</h4><div class='badge-row'>` +
            cats[c].map(x=>`<span class='badge'>${x.name}${x.version?' '+x.version:''}</span>`).join('') + '</div>';
          domainCatDiv.appendChild(block);
        });
        domainResult.classList.remove('hidden');
      } catch(err){
        domainError.textContent = err.message;
        domainError.classList.remove('hidden');
      }
    });

    function renderDomainLookup(domain, data){
      _lastDomainLookup = {domain, data};
      domainTechGrid.innerHTML='';
      (data.technologies||[]).forEach(t=>{
        const el = document.createElement('div');
        el.className='tech has-icon';
        el.innerHTML = `<div class='tech-head'>${techIconHTML(t.name||'', t.version)}<div style='display:flex;flex-direction:column;gap:.3rem'><h3>${t.name||''}</h3>` + (t.version?`<div class='version'>${t.version}</div>`:'') + `</div></div>` + `<div class='badge-row'>${(t.categories||[]).map(c=>`<span class='badge'>${c}</span>`).join('')}</div>`;
        domainTechGrid.appendChild(el);
      });
    }

    // Bulk upload
    const fileInput = document.getElementById('fileInput');
    const bulkStatus = document.getElementById('bulk-status');
    const bulkWrapper = document.getElementById('bulk-table-wrapper');
    const bulkTableBody = document.querySelector('#bulk-table tbody');

    let _bulkDomains = [];
    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      _bulkDomains = Array.from(new Set(text.split(/\r?\n/).map(l=>l.trim().toLowerCase()).filter(Boolean)));
      if(!_bulkDomains.length){
        bulkStatus.textContent='No valid domains found';
        bulkStatus.classList.remove('hidden');
        bulkWrapper.classList.add('hidden');
        return;
      }
      bulkStatus.classList.add('hidden');
      bulkWrapper.classList.remove('hidden');
      bulkTableBody.innerHTML = '';
      _bulkDomains.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d}</td><td>ready</td><td>-</td><td>-</td>`;
        bulkTableBody.appendChild(tr);
      });
    });

    async function runBulkScan(downloadCsv=false){
      if(!_bulkDomains.length){
        bulkStatus.textContent='Upload list terlebih dahulu.';
        bulkStatus.classList.remove('hidden');
        return;
      }
      bulkStatus.classList.add('hidden');
      // mark queued
      Array.from(bulkTableBody.rows).forEach(r=> r.cells[1].textContent='queued');
      // Use backend defaults (timeout, retries, concurrency). Minimal payload.
      const payload = {domains: _bulkDomains};
      try {
        if(downloadCsv){
          // request CSV
            const resp = await fetch('/bulk?format=csv', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if(!resp.ok){
              const txt = await resp.text();
              bulkStatus.textContent = 'Bulk CSV failed: '+txt.slice(0,120);
              bulkStatus.classList.remove('hidden');
              return;
            }
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'bulk_scan.csv';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
            return;
        }
        const resp = await postJSON('/bulk', payload);
        resp.results.forEach((r,i)=>{
          const row = bulkTableBody.rows[i];
          if(!row) return;
          if(r.status==='ok'){
            const top = (r.technologies||[])[0];
            row.cells[1].textContent = 'ok';
            row.cells[2].textContent=r.technologies.length;
            row.cells[3].textContent=top? top.name + (top.version? ' '+top.version:'') : '-';
          } else {
            row.cells[1].textContent='error';
            row.cells[2].textContent='0';
            row.cells[3].textContent=r.error||'-';
          }
        });
      } catch(err){
        bulkStatus.textContent=err.message;
        bulkStatus.classList.remove('hidden');
      }
    }
    document.getElementById('bulk-scan-btn').addEventListener('click', ()=> runBulkScan(false));
    document.getElementById('bulk-download-csv').addEventListener('click', ()=> runBulkScan(true));
  </script>
</body>
</html>
